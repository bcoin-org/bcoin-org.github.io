<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="Learn how to make and redeem a time locked transaction using Bitcoin
scripts with bcoin. In this guide, we will have a function that
creates a script that locks a UTXO for a predetermined amount of
time as well as separately learn how to sign these types of special
inputs.">
	<meta name="author" content="Buck Perley">

	<title>Bcoin Guide | Time Locked Bitcoin Transactions w/ CLTV</title>

	<!-- Favicons -->
	<!-- old
	<link rel="shortcut icon" href="../assets/images/bcoin-ico.png">-->

	<!-- generated from http://www.favicon-generator.org/ -->
	<link rel="apple-touch-icon" sizes="57x57" href="../assets/images/apple-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="../assets/images/apple-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="../assets/images/apple-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="../assets/images/apple-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="../assets/images/apple-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="../assets/images/apple-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="../assets/images/apple-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="../assets/images/apple-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="../assets/images/apple-icon-180x180.png">
	<link rel="icon" type="image/png" sizes="192x192"  href="../assets/images/android-icon-192x192.png">
	<link rel="icon" type="image/png" sizes="32x32" href="../assets/images/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="96x96" href="../assets/images/favicon-96x96.png">
	<link rel="icon" type="image/png" sizes="16x16" href="../assets/images/favicon-16x16.png">
	<link rel="manifest" href="../assets/images/manifest.json">
	<meta name="msapplication-TileColor" content="#ffffff">
	<meta name="msapplication-TileImage" content="../assets/images/ms-icon-144x144.png">
	<meta name="theme-color" content="#ffffff">

	<!-- Web Fonts -->
	<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700' rel='stylesheet'>
	<link href='https://fonts.googleapis.com/css?family=Montserrat:700' rel='stylesheet' type='text/css'>

	<!-- Bootstrap core CSS -->
	<link href="../assets/bootstrap/css/bootstrap.min.css" rel="stylesheet">

	<!-- Code Snippet CSS -->
	<link href="../assets/css/prism.css" rel="stylesheet">

	<link href="../assets/css/custom.css" rel="stylesheet">

	<!-- Icon Fonts -->
	<link href="../assets/css/font-awesome.min.css" rel="stylesheet">
	<link href="../assets/css/simple-line-icons.css" rel="stylesheet">

	<!-- Plugins -->
	<link href="../assets/css/magnific-popup.css" rel="stylesheet">
	<link href="../assets/css/owl.carousel.css" rel="stylesheet">
	<link href="../assets/css/flexslider.css" rel="stylesheet">
	<link href="../assets/css/animate.min.css" rel="stylesheet">

	<!-- Template core CSS -->
	<link href="../assets/css/vertical.min.css" rel="stylesheet">
	<link href="../assets/css/template.css" rel="stylesheet">

	<!-- Google Analytics Tracking -->
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-96446060-1', 'auto');
        ga('send', 'pageview');
    </script>
</head>
<body>

	<!-- PRELOADER -->
	<div class="page-loader">
		<div class="img-loader">Loading...
			<!-- Bcoin logo in SVG -->
			<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
				viewBox="0 0 200 56" style="enable-background:new 0 0 200 56;" xml:space="preserve">
			<g id="XMLID_108_">
				<g id="XMLID_123_">
					<path id="XMLID_124_" d="M8.4,51.8H3.2V4.2h5.2v19.2h0.8c1.2-2,2.8-3.6,4.8-4.7c2-1.1,4.3-1.6,6.7-1.6c2,0,4,0.4,5.8,1.2
						c1.8,0.8,3.4,1.9,4.8,3.3c1.4,1.5,2.5,3.2,3.3,5.4s1.2,4.6,1.2,7.3v1.4c0,2.8-0.4,5.2-1.2,7.4c-0.8,2.1-1.9,3.9-3.3,5.4
						c-1.4,1.5-3,2.6-4.9,3.3s-3.8,1.1-5.9,1.1c-1.1,0-2.2-0.1-3.3-0.4c-1.1-0.3-2.2-0.6-3.2-1.2c-1-0.5-1.9-1.2-2.8-1.9
						c-0.8-0.7-1.6-1.6-2.1-2.7H8.4V51.8z M19.4,47.7c1.6,0,3.1-0.3,4.4-0.9c1.3-0.6,2.5-1.4,3.5-2.4c1-1,1.8-2.3,2.3-3.8
						c0.6-1.5,0.8-3.2,0.8-5v-1.4c0-1.8-0.3-3.5-0.8-4.9c-0.6-1.5-1.3-2.7-2.3-3.8c-1-1.1-2.2-1.9-3.5-2.5c-1.4-0.6-2.8-0.9-4.4-0.9
						c-1.6,0-3,0.3-4.3,0.9c-1.3,0.6-2.5,1.5-3.5,2.6c-1,1.1-1.8,2.4-2.4,3.9c-0.6,1.5-0.9,3.2-0.9,5v0.8c0,1.9,0.3,3.6,0.9,5.1
						c0.6,1.5,1.4,2.8,2.4,3.9s2.2,1.9,3.5,2.5C16.4,47.4,17.9,47.7,19.4,47.7z"/>
				</g>
				<g id="XMLID_120_">
					<path id="XMLID_121_" d="M76.1,39.8c-0.4,1.9-1,3.6-1.8,5.2c-0.9,1.6-2,3-3.3,4.1s-2.9,2.1-4.7,2.7c-1.8,0.6-3.8,1-5.9,1
						c-2.3,0-4.5-0.4-6.6-1.2c-2.1-0.8-3.9-1.9-5.4-3.4c-1.6-1.5-2.8-3.3-3.7-5.4c-0.9-2.1-1.4-4.6-1.4-7.4v-0.8c0-2.7,0.5-5.2,1.4-7.4
						c0.9-2.2,2.1-4,3.7-5.5c1.6-1.5,3.4-2.7,5.4-3.5c2.1-0.8,4.3-1.2,6.6-1.2c2.1,0,4,0.3,5.8,1c1.8,0.6,3.3,1.5,4.7,2.7
						c1.4,1.2,2.5,2.5,3.3,4.1c0.9,1.6,1.5,3.3,1.8,5.2l-5.2,1.2c-0.1-1.2-0.5-2.3-1-3.4c-0.5-1.1-1.2-2.1-2.1-2.9
						c-0.9-0.8-1.9-1.5-3.2-2c-1.2-0.5-2.7-0.7-4.3-0.7c-1.6,0-3.1,0.3-4.5,0.9c-1.4,0.6-2.6,1.5-3.7,2.6c-1.1,1.1-1.9,2.4-2.5,4
						c-0.6,1.5-0.9,3.2-0.9,5v0.8c0,1.9,0.3,3.6,0.9,5.1c0.6,1.5,1.4,2.8,2.5,3.8c1.1,1,2.3,1.8,3.7,2.4c1.4,0.6,3,0.9,4.6,0.9
						s3.1-0.3,4.3-0.8c1.2-0.5,2.3-1.2,3.1-2c0.9-0.8,1.6-1.8,2.1-2.9c0.5-1.1,0.9-2.2,1-3.4L76.1,39.8z"/>
				</g>
				<g id="XMLID_116_">
					<path id="XMLID_117_" d="M117.2,35.4c0,2.8-0.5,5.3-1.4,7.5c-0.9,2.2-2.1,4-3.6,5.4c-1.5,1.5-3.3,2.6-5.3,3.4
						c-2,0.8-4.1,1.2-6.3,1.2c-2.2,0-4.3-0.4-6.3-1.2c-2-0.8-3.8-1.9-5.3-3.4c-1.5-1.5-2.7-3.3-3.6-5.4c-0.9-2.2-1.4-4.6-1.4-7.5v-0.8
						c0-2.8,0.5-5.2,1.4-7.4c0.9-2.2,2.1-4,3.7-5.5c1.5-1.5,3.3-2.6,5.3-3.4c2-0.8,4.1-1.2,6.3-1.2c2.2,0,4.3,0.4,6.3,1.2
						c2,0.8,3.8,1.9,5.3,3.4c1.5,1.5,2.8,3.3,3.7,5.5c0.9,2.2,1.4,4.6,1.4,7.4V35.4z M100.6,47.7c1.6,0,3.1-0.3,4.4-0.9
						c1.4-0.6,2.5-1.4,3.6-2.5c1-1.1,1.8-2.4,2.4-3.9c0.6-1.5,0.9-3.2,0.9-5.1v-0.8c0-1.8-0.3-3.5-0.9-5c-0.6-1.5-1.4-2.8-2.4-3.9
						c-1-1.1-2.2-1.9-3.6-2.6c-1.4-0.6-2.8-0.9-4.4-0.9c-1.6,0-3,0.3-4.4,0.9c-1.4,0.6-2.6,1.5-3.6,2.6c-1,1.1-1.8,2.4-2.4,3.9
						c-0.6,1.5-0.9,3.2-0.9,5v0.8c0,1.9,0.3,3.6,0.9,5.1c0.6,1.5,1.4,2.8,2.4,3.9c1,1.1,2.2,1.9,3.6,2.5C97.5,47.5,99,47.7,100.6,47.7z
						"/>
				</g>
				<g id="XMLID_112_">
					<path id="XMLID_113_" d="M127.6,46.9h11.6V23h-10.4v-4.9h15.6v28.9h10.8v4.9h-27.6V46.9z M137.1,8c0-1.3,0.5-2.4,1.4-3.4
						c0.9-0.9,2-1.4,3.3-1.4c1.3,0,2.4,0.5,3.3,1.4c0.9,0.9,1.4,2.1,1.4,3.4c0,1.3-0.5,2.4-1.4,3.4c-0.9,0.9-2,1.4-3.3,1.4
						c-1.3,0-2.4-0.5-3.3-1.4C137.5,10.4,137.1,9.3,137.1,8z"/>
				</g>
				<g id="XMLID_109_">
					<path id="XMLID_110_" d="M172.8,51.8h-5.2V18.1h5.2v5.7h0.8c2-4.4,5.6-6.7,10.7-6.7c3.8,0,6.9,1.2,9.1,3.6
						c2.3,2.4,3.4,6.1,3.4,10.9v20.2h-5.2V32.8c0-3.5-0.8-6.2-2.3-8c-1.6-1.8-3.7-2.7-6.3-2.7c-3.2,0-5.6,1.1-7.4,3.3s-2.7,5.1-2.7,8.8
						V51.8z"/>
				</g>
			</g>
			</svg>


		</div>
	</div>
	<!-- END PRELOADER -->

	<!-- HEADER -->
	<header class="header js-stick">
			<div class="container">
				<!-- YOUR LOGO HERE -->
				<div class="inner-header">
					<a class="inner-brand" href="../index.html">
						<img class="brand-light" src="../assets/images/logo-light.png" width="100" alt="">
						<img class="brand-dark" src="../assets/images/logo-dark.png" width="100" alt="">
					</a>
				</div>

				<!-- OPEN MOBILE MENU -->
				<div class="main-nav-toggle">
					<div class="nav-icon-toggle" data-toggle="collapse" data-target="#custom-collapse">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</div>
				</div>

				<!-- WIDGETS MENU -->
				<div class="inner-header pull-right hide-me">
					<div class="menu-extras clearfix">

						<!-- TELEGRAM LINK -->
						<div class="menu-item">
							<div class="">
								<a href="https://t.me/bcoinorg" target="_blank" id="" data-toggle="tooltip" title="" data-placement="bottom" data-original-title="Join us on Telegram!">
									<img src="../assets/images/telegram-app.svg" width="18" height="18"/>
									<span class=""></span>
								</a>
                            </div>
						</div>

						<!-- STACK EXCHANGE LINK -->
						<div class="menu-item">
							<div class="">
								<a href="https://bitcoin.stackexchange.com/questions/tagged/bcoin" target="_blank" id="" data-toggle="tooltip" title="" data-placement="bottom" data-original-title="Questions! Checkout Stack Exchange.">
									<img src="../assets/images/stack-exchange-icon.svg" width="18" height="18"/>
									<span class=""></span>
								</a>
                            </div>
						</div>

						<!-- GITHUB STUFF -->
						<div class="menu-item">
							<div class="">
								<a href="https://github.com/bcoin-org/bcoin" target="_blank" id="" data-toggle="tooltip" title="" data-placement="bottom" data-original-title="Visit bcoin on GitHub to see the code!">
									<img src="../assets/images/github_icon.svg" width="18" height="18"/>
									<span class=""></span>
								</a>
                            </div>
						</div>

						<div class="menu-item">
                            <div class="ghbuttons">
                                <a class="github-button" href="https://github.com/bcoin-org/bcoin" data-icon="octicon-star" data-count-href="/bcoin-org/bcoin/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star bcoin-org/bcoin on GitHub">Star</a>
                                <a class="github-button" href="https://github.com/bcoin-org/bcoin/fork" data-icon="octicon-repo-forked" data-count-href="/bcoin-org/bcoin/network" data-show-count="true" data-count-aria-label="# forks on GitHub" aria-label="Fork bcoin-org/bcoin on GitHub">Fork</a>
                            </div>
                        </div>




					</div>
				</div>

				<!-- MAIN MENU -->
				<nav id="custom-collapse" class="main-nav collapse clearfix">
					<ul class="inner-nav pull-right">

						<!-- HOME -->
						<li><a href="../index.html">Home</a></li>
						<!-- END HOME -->

						<!-- FEATURES -->
						<li><a href="../index.html#features">What is Bcoin</a></li>
						<!-- END FEATURES -->

						<!-- GUIDES -->
						<li><a href="../guides.html">Guides</a></li>
						<!-- GUIDES -->

						<!-- API REFERENCE - newer, how to interact once you're setup -->
						<li><a href="../api-docs/index.html">API Docs</a></li>
						<!-- END API -->

						<!-- FULL DOCS - older, full reference
						<li><a href="https://bcoin.io/docs/index.html">Docs</a></li> -->
						<!-- END DOCS -->

						<!-- DIVIDER
						<li><a>&nbsp;</a></li>

						<li><a href="#">All Demos</a></li>-->

					</ul>
				</nav>

			</div>
		</header>
	<!-- END HEADER -->

	<!-- WRAPPER -->
	<div class="wrapper">

		<!-- PAGE TITLE -->
		<section class="module-sm bg-white-dark" data-background="../assets/images/bg-header.jpg">
			<div class="container">

				<div class="row">
					<div class="col-sm-12 text-center">

						<h2 class="montserrat text-uppercase m-b-10"><span class="text-highlight-black" style="line-height: 1.5;">&nbsp;Guides &nbsp;and &nbsp;Videos&nbsp;</span></h2>

					</div>
				</div>

			</div>
		</section>
		<!-- END PAGE TITLE -->

		<!-- GUIDES/TUTORIALS -->
		<section class="module" style="padding-top:70px !important;">
			<div class="container">

				<div class="row">
					<!-- START OF ARTICLE CONTAINER -->
					<div class="col-sm-9 blog-content post-thumbnail">
						<!-- POST IMAGE -->
						<article class="post format-image">
							<div class="row">
								<!--<div class="col-sm-5">
									<div class="post-preview">
										<a href="#"><img src="../assets/images/guides/get-started.png" alt=""></a>
									</div>
								</div>-->

								<!-- after re-enabling the above code, change the col-sm below to col-sm-7 -->
								<div class="panel-group">
									<div class="col-sm-12 panel panel-default">
										<div class="post-content" style="color:#000;">
					<!-- START OF GUIDE -->
<h2 class="post-title panel-title" id="time-locked-bitcoin-transactions-w-cltv">Time Locked Bitcoin Transactions w/ CLTV</h2><ul class="post-meta"><li class="author">By Buck Perley</li></ul><h2 id="what-is-quot;cltv&quot;?">What is &quot;CLTV&quot;?</h2><p>CLTV is an op code in the Bitcoin scripting language that allows you
to lock a UTXO (Unspent Transaction Output) by time. i.e. a coin
cannot be spent until a certain time or blockchain height has been past.
In this guide, we will have a function that creates a script that
locks a UTXO for a predetermined amount of time using the CLTV op code
as well as separately learn how to sign these types of special inputs.</p>
<h2 id="unlocking-an-unspent-tx-output">Unlocking an Unspent TX Output (UTXO)</h2><p>Sending funds in Bitcoin is really just about pointing to the output
of a previous transaction, making that the input for a new transaction,
and, then satisfying some locking condition on that previous output.
&quot;Scripts&quot; are conditions that need to be satisfied on an output to
prove ownership. You can have a Bitcoin script that is locked with the
math problem &quot;What is 2 + 5&quot;, and anyone that knows to answer &quot;7&quot; can &quot;prove&quot;
ownership over that output (Check out this guide, <a href="https://bcoin.io/guides/scripting.html">Intro To Scripting</a>
to see how to write and redeem this simple script in bcoin, and <a href="https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch06.asciidoc#a-simple-script">this section</a> in Mastering Bitcoin for a helpful walkthrough).</p>
<p>In the vast majority of Bitcoin and other cryptocurrency transactions,
you prove ownership by signing a transaction input with the private key
(basically a password that is stored in your wallet) that corresponds to
the address that the source output was sent to. I.e. The UTXO is locked
by the requirement that some signature must match a public key or public key
hash that is on the execution stack.</p>
<p>An output that is locked with CLTV works more or less the same way but adds another
condition that before the signature is even accepted, a certain amount of
time must have passed.</p>
<p>In pseudo-code, the script will look like this:</p>
<pre class="snippet line-numbers language-bash "><code class="line-numbers language-bash">Locktime <span class="token punctuation">(</span>in blocks or Unix epoch time<span class="token punctuation">)</span>
Check <span class="token keyword">if</span> locktime is <span class="token function">less</span> than nLocktime of transaction<span class="token punctuation">;</span> execution fails <span class="token keyword">if</span> not
Check public key <span class="token function">hash</span> matches
Check <span class="token keyword">if</span> the signature validates</code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><p>In Bitcoin, this locking script will look something like this:</p>
<pre class="snippet line-numbers language-bash "><code class="line-numbers language-bash"><span class="token operator">&lt;</span>some amt of time<span class="token operator">></span> CHECKLOCKTIMEVERIFY DROP DUP HASH160
<span class="token operator">&lt;</span>Redeeming Public Key Hash<span class="token operator">></span> EQUALVERIFY CHECKSIG</code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><p>To learn more about CLTV and how it works in Bitcoin, checkout <a href="https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch07.asciidoc">chapter 07 in
Mastering Bitcoin</a>. See <a href="https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch06.asciidoc#transaction-scripts-and-script-language">Chapter 06</a>
for more information on how the stack and scripts operate.</p>
<p>This guide will be broken into two parts. First we will walk through
creating and redeeming a mock transaction with no real coins. Next we will do the
same thing on a live regtest network using the bcoin wallet and API.</p>
<p>(If you want to see the full code, checkout the repo <a href="https://github.com/bucko13/cltv">here</a>)</p>
<h2 id="the-guide--mock-transaction">The Guide - Mock Transaction</h2><p>Before moving on to the transaction there is some setup that will be useful
for both approaches. Note that this guide assumes use with Segwit transactions so
inputs and redeem scripts are stored in the witness field.</p>
<h3 id="setup">Setup</h3><p>Let&#39;s first setup the constants and import the modules we will need to create
and spend our transactions.</p>
<pre class="snippet line-numbers language-javascript "><code class="line-numbers language-javascript"><span class="token comment">// first the modules we will be using from bcoin</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>
  Amount<span class="token punctuation">,</span>
  Coin<span class="token punctuation">,</span>
  KeyRing<span class="token punctuation">,</span>
  MTX<span class="token punctuation">,</span>
  Network<span class="token punctuation">,</span>
  Outpoint<span class="token punctuation">,</span>
  Script<span class="token punctuation">,</span>
  ScriptNum<span class="token punctuation">,</span>
  Stack
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bcoin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// some NodeJS helpers</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'assert'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// a helper object with information</span>
<span class="token comment">// about the regtest network</span>
<span class="token keyword">const</span> network <span class="token operator">=</span> Network<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'regtest'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><h3 id="creating-the-script">Creating the Script</h3><p>Let&#39;s create a function that takes a locktime and a publicKeyHash
that corresponds to the private key that can redeem the transaction
and returns an object of type <code>Script</code>. This script is what will
ultimately be used to lock our UTXO, i.e. the locking script.</p>
<p>Note that for CLTV, the locktime can either be a block height <em>or</em>
Unix Epoch timestamp (seconds since Jan-1-1970) if above 500 million (
<a href="https://github.com/bitcoin/bips/blob/master/bip-0065.mediawiki">See BIP-065 Specs</a>).</p>
<pre class="snippet line-numbers language-javascript "><code class="line-numbers language-javascript"><span class="token comment">/**
 * @param {String} locktime - Time that the script can not
 * be redeemed before
 * @param {Buffer} public key hash
 * @returns {Script}
**/</span>
<span class="token keyword">function</span> <span class="token function">createScript</span><span class="token punctuation">(</span>locktime<span class="token punctuation">,</span> publicKeyHash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> pkh<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> publicKeyHash <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span>
    pkh <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>publicKeyHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> pkh <span class="token operator">=</span> publicKeyHash<span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">isBuffer</span><span class="token punctuation">(</span>pkh<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'publicKey must be a Buffer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>
    locktime<span class="token punctuation">,</span>
    <span class="token string">'Must pass in a locktime argument, either block height or UNIX epoch time'</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> script <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Script</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// lock the transactions until</span>
  <span class="token comment">// the locktime has been reached</span>
  script<span class="token punctuation">.</span><span class="token function">pushNum</span><span class="token punctuation">(</span>ScriptNum<span class="token punctuation">.</span><span class="token function">fromString</span><span class="token punctuation">(</span>locktime<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// check the locktime</span>
  script<span class="token punctuation">.</span><span class="token function">pushSym</span><span class="token punctuation">(</span><span class="token string">'CHECKLOCKTIMEVERIFY'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// if verifies, drop time from the stack</span>
  script<span class="token punctuation">.</span><span class="token function">pushSym</span><span class="token punctuation">(</span><span class="token string">'drop'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// duplicate item on the top of the stack</span>
  <span class="token comment">// which should be.the public key</span>
  script<span class="token punctuation">.</span><span class="token function">pushSym</span><span class="token punctuation">(</span><span class="token string">'dup'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// hash the top item from the stack (the public key)</span>
  script<span class="token punctuation">.</span><span class="token function">pushSym</span><span class="token punctuation">(</span><span class="token string">'hash160'</span><span class="token punctuation">)</span>
  <span class="token comment">// push the hash to the top of the stack</span>
  script<span class="token punctuation">.</span><span class="token function">pushData</span><span class="token punctuation">(</span>pkh<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// confirm they match</span>
  script<span class="token punctuation">.</span><span class="token function">pushSym</span><span class="token punctuation">(</span><span class="token string">'equalverify'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// confirm the signature matches</span>
  script<span class="token punctuation">.</span><span class="token function">pushSym</span><span class="token punctuation">(</span><span class="token string">'checksig'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Compile the script to its binary representation</span>
  <span class="token comment">// (you must do this if you change something!).</span>
  script<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> script<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><p>This script is pretty long and could be expensive to send in a transaction.
Similar to the way multisignature transactions are typically handled,
let&#39;s create a method to embed the script into a P2WSH (Pay to Witness
Script Hash) address.</p>
<pre class="snippet line-numbers language-javascript "><code class="line-numbers language-javascript"><span class="token comment">/**
 * @param {Script} script to get corresponding address for
 * @param {Network} to determine encoding based on network
 * @returns {Address} - p2wsh segwit address for specified network
**/</span>
<span class="token keyword">function</span> <span class="token function">getAddress</span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> network<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// get the hash of the script</span>
  <span class="token comment">// and derive address from that</span>
  <span class="token keyword">const</span> p2wsh <span class="token operator">=</span> script<span class="token punctuation">.</span><span class="token function">forWitness</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> segwitAddress <span class="token operator">=</span> p2wsh<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBech32</span><span class="token punctuation">(</span>network<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> segwitAddress<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><h3 id="making-the-transaction">Making the transaction</h3><p>Here are the steps we&#39;ll be walking through:</p>
<p>1) Setup keyrings - In order to mimic spending and receiving from a wallet,
we&#39;re going to create some keyrings, which will manage the public-private
keypairs needed to generate addresses and redeem UTXOs. Typically, these
are managed by a wallet, but for the purposes of demonstration,
we&#39;ll do this manually.</p>
<p>2) Make the script and save it to keychain. <strong>Note:</strong> when making P2SH or
P2WSH scripts, you need to keep track of the script in order to redeem it later.</p>
<p>3) Create the P2WSH address to receive (and lock) the funds to</p>
<p>4) Create our fake tx that sends an output to our locking address</p>
<p>5) Setup our redeeming tx with the locked coin as our input, spending to
another address, and the correct locktime</p>
<p>6) Sign and verify the input</p>
<pre class="snippet line-numbers language-javascript "><code class="line-numbers language-javascript"><span class="token comment">// We'll use this as a reference for later.</span>
<span class="token comment">// to get value in satoshis all you need is `amountToFund.toValue()`;</span>
<span class="token keyword">const</span> amountToFund <span class="token operator">=</span> Amount<span class="token punctuation">.</span><span class="token function">fromBTC</span><span class="token punctuation">(</span><span class="token string">'.5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// flags are for script and transaction verification</span>
<span class="token keyword">const</span> flags <span class="token operator">=</span> Script<span class="token punctuation">.</span>flags<span class="token punctuation">.</span>STANDARD_VERIFY_FLAGS<span class="token punctuation">;</span>

<span class="token comment">// 1) Setup keyrings</span>
<span class="token keyword">const</span> keyring <span class="token operator">=</span> KeyRing<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> keyring2 <span class="token operator">=</span> KeyRing<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// can only be redeemed after the 100th block has been mined</span>
<span class="token keyword">const</span> locktime <span class="token operator">=</span> <span class="token string">'100'</span><span class="token punctuation">;</span>
keyring<span class="token punctuation">.</span>witness <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
keyring2<span class="token punctuation">.</span>witness <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token comment">// 2) Get hash, generate the locking script and save it to keyring</span>
<span class="token keyword">const</span> pkh <span class="token operator">=</span> keyring<span class="token punctuation">.</span><span class="token function">getKeyHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> script <span class="token operator">=</span> <span class="token function">createScript</span><span class="token punctuation">(</span>locktime<span class="token punctuation">,</span> pkh<span class="token punctuation">)</span><span class="token punctuation">;</span>
keyring<span class="token punctuation">.</span>script <span class="token operator">=</span> script<span class="token punctuation">;</span>

<span class="token comment">// 3) Create the address</span>
<span class="token keyword">const</span> lockingAddr <span class="token operator">=</span> <span class="token function">getAddress</span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> network<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 4) Create our funding transaction that sends</span>
<span class="token comment">// 50,000 satoshis to our locking address</span>
<span class="token keyword">const</span> cb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MTX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

cb<span class="token punctuation">.</span><span class="token function">addInput</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  prevout<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Outpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  script<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Script</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  sequence<span class="token punctuation">:</span> <span class="token number">0xffffffff</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Send 50,000 satoshis to our locking address.</span>
<span class="token comment">// this will lock up the funds to whoever can solve</span>
<span class="token comment">// the CLTV script</span>
cb<span class="token punctuation">.</span><span class="token function">addOutput</span><span class="token punctuation">(</span>lockingAddr<span class="token punctuation">,</span> amountToFund<span class="token punctuation">.</span><span class="token function">toValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Convert the coinbase output to a Coin object</span>
<span class="token comment">// In reality you might get these coins from a wallet.</span>
<span class="token comment">// `fromTX` will take an output from a previous</span>
<span class="token comment">// tx and turn it into a coin object</span>
<span class="token comment">// (the second param is the index of the target UTXO)</span>
<span class="token keyword">const</span> coin <span class="token operator">=</span> Coin<span class="token punctuation">.</span><span class="token function">fromTX</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 5) Setup the redeeming transaction</span>
<span class="token comment">// Start with an empty mutable transaction</span>
<span class="token keyword">let</span> mtx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MTX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// add our cb coin as the input (i.e. the "funding" UTXO)</span>
mtx<span class="token punctuation">.</span><span class="token function">addCoin</span><span class="token punctuation">(</span>coin<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// get an address to send the funds from the coin to</span>
<span class="token keyword">const</span> receiveAddr <span class="token operator">=</span> keyring2<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token string">'string'</span><span class="token punctuation">,</span> network<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// value of the input minus arbitrary amount for fee</span>
<span class="token comment">// normally we could do this by querying our node to estimate rate</span>
<span class="token comment">// or use the `fund` method if we had other coins to spend with</span>
<span class="token keyword">const</span> receiveValue <span class="token operator">=</span> coin<span class="token punctuation">.</span>value <span class="token operator">-</span> <span class="token number">1000</span><span class="token punctuation">;</span>
mtx<span class="token punctuation">.</span><span class="token function">addOutput</span><span class="token punctuation">(</span>receiveAddr<span class="token punctuation">,</span> receiveValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// So now we have an mtx with the right input and output</span>
<span class="token comment">// but our input still hasn't been signed</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mtx:'</span><span class="token punctuation">,</span> mtx<span class="token punctuation">)</span><span class="token punctuation">;</span></code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><h3 id="input-script-and-sign-the-inputs">Input Script and Sign the Inputs</h3><p>We&#39;re going to create two custom methods to handle this part
since we can use it for the live transactions as well. The <code>MTX</code>
primitive in bcoin has its own version of these (see the code
<a href="https://github.com/bcoin-org/bcoin/blob/master/lib/primitives/mtx.js">here</a>)
but out of the box they can only handle standard transaction types.</p>
<h4 id="scriptinput">scriptInput</h4><p>Roughly speaking what <code>scriptInput</code> does is take the index of the input
you&#39;re scripting, the coin you&#39;re creating the input from, and
the keyring used to redeem it. It then templates the input (or witness
in this case), adding the full redeem script needed to verify the script hash
and putting OP_0 in the place of the signature.</p>
<p>The actual method has more checks in it to see what kind of input,
(P2PKH, P2PK, P2SH, etc.) it is scripting for.</p>
<pre class="snippet line-numbers language-javascript "><code class="line-numbers language-javascript"><span class="token comment">/* script the inputs w/ our custom script for an mtx
 * This is modeled after the scriptInput method on
 * the `MTX` class
 * @param {MTX} mtx with unscripted input
 * @param {Number} index - index of input to script
 * @param {Coin} coin - UTXO we are spending
 * @param {KeyRing} ring - keyring we are signing with
 * @returns {MTX}
*/</span>
<span class="token keyword">function</span> <span class="token function">scriptInput</span><span class="token punctuation">(</span>mtx<span class="token punctuation">,</span> index<span class="token punctuation">,</span> coin<span class="token punctuation">,</span> ring<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> input <span class="token operator">=</span> mtx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> prev <span class="token operator">=</span> coin<span class="token punctuation">.</span>script<span class="token punctuation">;</span>
  <span class="token keyword">const</span> wsh <span class="token operator">=</span> prev<span class="token punctuation">.</span><span class="token function">getWitnessScripthash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>ring <span class="token keyword">instanceof</span> <span class="token class-name">KeyRing</span><span class="token punctuation">,</span> <span class="token string">'Must pass a KeyRing to scriptInput'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// this is the redeem script used to verify the p2wsh hash</span>
  <span class="token keyword">const</span> wredeem <span class="token operator">=</span> ring<span class="token punctuation">.</span><span class="token function">getRedeem</span><span class="token punctuation">(</span>wsh<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>wredeem<span class="token punctuation">,</span> <span class="token string">'keyring has no redeem script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> vector <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// first add empty space in stack for signature and public key</span>
  vector<span class="token punctuation">.</span><span class="token function">pushInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  vector<span class="token punctuation">.</span><span class="token function">pushInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// add the raw redeem script to the stack</span>
  vector<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>wredeem<span class="token punctuation">.</span><span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  input<span class="token punctuation">.</span>witness<span class="token punctuation">.</span><span class="token function">fromStack</span><span class="token punctuation">(</span>vector<span class="token punctuation">)</span><span class="token punctuation">;</span>
  mtx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> input<span class="token punctuation">;</span>
  <span class="token keyword">return</span> mtx<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><h4 id="signinput">signInput</h4><p><code>signInput</code> takes the same parameters, simply verifies the input/witness,
replaces the OP_0 with a signature to satisfy the script.</p>
<p>This is a simplified version of the version of <code>signInput</code> that is on
the <code>MTX</code> class in bcoin.</p>
<pre class="snippet line-numbers language-javascript "><code class="line-numbers language-javascript"><span class="token comment">/* This is modeled after the signInput method on
 * the `MTX` class
 * @param {MTX} mtx with unscripted input
 * @param {Number} index - index of input to script
 * @param {Coin} coin- UTXO we are spending
 * @param {KeyRing} ring - keyring we are signing with
 * @returns {MTX}
*/</span>
<span class="token keyword">function</span> <span class="token function">signInput</span><span class="token punctuation">(</span>mtx<span class="token punctuation">,</span> index<span class="token punctuation">,</span> coin<span class="token punctuation">,</span> ring<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> input <span class="token operator">=</span> mtx<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> witness<span class="token punctuation">,</span> version<span class="token punctuation">;</span>

  <span class="token keyword">const</span> redeem <span class="token operator">=</span> input<span class="token punctuation">.</span>witness<span class="token punctuation">.</span><span class="token function">getRedeem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">assert</span><span class="token punctuation">(</span>
    redeem<span class="token punctuation">,</span>
    <span class="token string">'Witness has not been templated'</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  witness <span class="token operator">=</span> input<span class="token punctuation">.</span>witness<span class="token punctuation">;</span>
  <span class="token comment">// version is for the signing to indicate signature hash version</span>
  <span class="token comment">// 0=legacy, 1=segwit</span>
  version <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> stack <span class="token operator">=</span> witness<span class="token punctuation">.</span><span class="token function">toStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// let's get the signature and replace the placeholder</span>
  <span class="token comment">// in the stack. We can use the MTX `signature` method</span>
  <span class="token keyword">const</span> sig <span class="token operator">=</span>
    mtx<span class="token punctuation">.</span><span class="token function">signature</span><span class="token punctuation">(</span>
      index<span class="token punctuation">,</span>
      redeem<span class="token punctuation">,</span>
      coin<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
      ring<span class="token punctuation">.</span>privateKey<span class="token punctuation">,</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span>
      version
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  stack<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>

  stack<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> ring<span class="token punctuation">.</span><span class="token function">getPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  witness<span class="token punctuation">.</span><span class="token function">fromStack</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> mtx<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><p>Now that we can script and sign, let&#39;s finish off the transaction!
In addition to signing, we also need to set the nLocktime parameter
of the transaction. In a live blockchain environment this will be
checked against the current state of the chain in the mempool. So,
a transaction with an nLocktime later than the current block height
or time, will be rejected as invalid.</p>
<pre class="snippet line-numbers language-javascript "><code class="line-numbers language-javascript"><span class="token comment">// Now set the locktime</span>
<span class="token comment">// You can test if the CLTV script is working or not</span>
<span class="token comment">// by changing this to a value less than what our script requires</span>
<span class="token comment">// which will cause the `mtx.verify` call to fail below</span>
mtx<span class="token punctuation">.</span><span class="token function">setLocktime</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>locktime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mtx <span class="token operator">=</span> <span class="token function">scriptInput</span><span class="token punctuation">(</span>mtx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> coin<span class="token punctuation">,</span> keyring<span class="token punctuation">)</span><span class="token punctuation">;</span>
mtx <span class="token operator">=</span> <span class="token function">signInput</span><span class="token punctuation">(</span>mtx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> coin<span class="token punctuation">,</span> keyring<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// if you console log the input being signed,</span>
<span class="token comment">// you'll notice it now has a witness stack and redeem script</span>
<span class="token comment">// before script, witness, and redeem were empty</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'signed mtx:'</span><span class="token punctuation">,</span> mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">assert</span><span class="token punctuation">(</span>mtx<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'mtx did not verify'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// make tx immutable</span>
<span class="token keyword">const</span> tx <span class="token operator">=</span> mtx<span class="token punctuation">.</span><span class="token function">toTX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// it should still verify (need mtx's coin view to verify tx)</span>
<span class="token function">assert</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>mtx<span class="token punctuation">.</span>view<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'tx did not verify'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Transaction verified!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><h2 id="a-live-cltv-transaction">A Live CLTV Transaction</h2><p>Let&#39;s test this on a regtest network that way we can easily
mine our own blocks to verify whether or not everything is working.
If the coin being sent to the CLTV address was originated from mining,
remember it requires at least 100 confirmations to be spent.</p>
<p>Some of the key differences doing this live:</p>
<p>1) We need to use real UTXOs/Coins</p>
<p>2) We need to manually keep track of the redeem script</p>
<p>3) We will interact with the REST API for signing
of our transaction</p>
<p>4) We will need to check against the real height of
a blockchain in order to redeem</p>
<p>First we&#39;re going to need to setup our bcoin clients so we can talk
to our node and wallet. Make sure you have
<a href="https://www.npmjs.com/package/bclient">bclient installed</a>.</p>
<pre class="snippet line-numbers language-javascript "><code class="line-numbers language-javascript"><span class="token comment">// make sure you've installed bclient to your project</span>
<span class="token comment">// `npm install --save bclient`</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> WalletClient<span class="token punctuation">,</span> NodeClient <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bclient'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> network <span class="token operator">=</span> Network<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'regtest'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// if your node needs an API key for access</span>
<span class="token comment">// you can import it like this for use in setting up your client</span>
<span class="token keyword">const</span> apiKey <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'./secrets.env'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> clientOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  network<span class="token punctuation">:</span> network<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
  apiKey<span class="token punctuation">:</span> apiKey<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> walletClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WalletClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>clientOptions<span class="token punctuation">,</span> port<span class="token punctuation">:</span> network<span class="token punctuation">.</span>walletPort<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> nodeClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NodeClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>clientOptions<span class="token punctuation">,</span> port<span class="token punctuation">:</span> network<span class="token punctuation">.</span>rpcPort <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><p>Since the bcoin wallet doesn&#39;t natively support CLTV coins,
we&#39;re going to implement our own naive persistent storage so that
we can keep a reference to the redeem script, locking address (P2WSH address),
locktime, and the redeem address. We&#39;ll do this by saving this information
to a json object in a separate text file.</p>
<p>For this portion of the code, we&#39;re going to have two evaluation branches.
We&#39;ll first check if we have this file with information saved to it. If we don&#39;t,
then we need to make the locking transaction. If we do, then we check if the current
block height meets the locktime requirement (saved in our document) and
create, sign, and broadcast our redeeming transaction</p>
<pre class="snippet line-numbers language-javascript "><code class="line-numbers language-javascript"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">lockAndRedeemCLTV</span><span class="token punctuation">(</span>walletId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> txInfoPath <span class="token operator">=</span> <span class="token string">'./tx-info.json'</span><span class="token punctuation">;</span> <span class="token comment">// this is where we'll persist our info</span>
    <span class="token keyword">const</span> wallet <span class="token operator">=</span> walletClient<span class="token punctuation">.</span><span class="token function">wallet</span><span class="token punctuation">(</span>walletId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// instantiate a client for our wallet</span>

    <span class="token keyword">let</span> redeemScript<span class="token punctuation">,</span> lockingAddr<span class="token punctuation">,</span> locktime<span class="token punctuation">;</span>

    <span class="token comment">// check if file exists and if there is info saved to it</span>
    <span class="token keyword">let</span> txInfo <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>txInfoPath<span class="token punctuation">)</span> <span class="token operator">?</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>txInfoPath<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>txInfo<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// No saved transaction, so let's create it and then</span>
      <span class="token comment">// save the information for later</span>

      <span class="token comment">// Step 1: Setup wallet client and confirm balance</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> balance <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> wallet<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>balance<span class="token punctuation">.</span>confirmed <span class="token operator">></span> amountToFund<span class="token punctuation">.</span><span class="token function">toValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'Not enough funds!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Step 2: Setup keyring w/ pkh and create locking address</span>
      <span class="token comment">// that can be redeemed by our real wallet after a set locktime</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> publicKey<span class="token punctuation">,</span> address <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> wallet<span class="token punctuation">.</span><span class="token function">createAddress</span><span class="token punctuation">(</span><span class="token string">'default'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// create the keyring from the public key</span>
      <span class="token comment">// and get the public key hash for the locking script</span>
      <span class="token keyword">const</span> keyring <span class="token operator">=</span> KeyRing<span class="token punctuation">.</span><span class="token function">fromKey</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      keyring<span class="token punctuation">.</span>witness <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> pkh <span class="token operator">=</span> keyring<span class="token punctuation">.</span><span class="token function">getKeyHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Get current height and set locktime to 10 blocks from now</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> chain<span class="token punctuation">:</span> <span class="token punctuation">{</span> height <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> nodeClient<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      locktime <span class="token operator">=</span> height <span class="token operator">+</span> <span class="token number">10</span><span class="token punctuation">;</span>

      <span class="token comment">// create the script and address that can be redeemed by our wallet</span>
      redeemScript <span class="token operator">=</span> <span class="token function">createScript</span><span class="token punctuation">(</span>locktime<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pkh<span class="token punctuation">)</span><span class="token punctuation">;</span>
      lockingAddr <span class="token operator">=</span> <span class="token function">getAddress</span><span class="token punctuation">(</span>redeemScript<span class="token punctuation">,</span> network<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Step 3: use the wallet client to send funds to the locking address</span>
      <span class="token keyword">const</span> output <span class="token operator">=</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">:</span> amountToFund<span class="token punctuation">.</span><span class="token function">toValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        address<span class="token punctuation">:</span> lockingAddr
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> lockedTx <span class="token operator">=</span> <span class="token keyword">await</span> wallet<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> outputs<span class="token punctuation">:</span> <span class="token punctuation">[</span>output<span class="token punctuation">]</span><span class="token punctuation">,</span> rate<span class="token punctuation">:</span> <span class="token number">7000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'transaction sent to mempool'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// save the transaction information to to a file</span>
      txInfo <span class="token operator">=</span> <span class="token punctuation">{</span> lockedTx<span class="token punctuation">,</span> lockingAddr<span class="token punctuation">,</span> redeemScript<span class="token punctuation">,</span> locktime<span class="token punctuation">,</span> redeemAddress<span class="token punctuation">:</span> address <span class="token punctuation">}</span><span class="token punctuation">;</span>
      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>txInfoPath<span class="token punctuation">,</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// mine one block to get tx on chain</span>
      <span class="token comment">// make sure you're doing this on regtest or simnet and</span>
      <span class="token comment">// not testnet or mainnet</span>
      <span class="token comment">// this method won't work if you don't have a</span>
      <span class="token comment">// coinbase address set on your miner</span>
      <span class="token comment">// you can also use bPanel and the @bpanel/simple-mining</span>
      <span class="token comment">// plugin to do this instead</span>
      <span class="token keyword">const</span> minedBlock <span class="token operator">=</span> <span class="token keyword">await</span> nodeClient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">'generate'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Block mined'</span><span class="token punctuation">,</span> minedBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// if the txInfo file exists then we know we have a locked tx</span>
      <span class="token comment">// so let's get the information we need to start redeeming!</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span>
        lockedTx<span class="token punctuation">,</span>
        lockingAddr<span class="token punctuation">,</span>
        redeemScript<span class="token punctuation">,</span>
        locktime<span class="token punctuation">,</span>
        redeemAddress
      <span class="token punctuation">}</span> <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 1) let's get the current block height to check if we can actually redeem</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> chain<span class="token punctuation">:</span> <span class="token punctuation">{</span> height <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> nodeClient<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// in reality this could be block height or Unix epoch time</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>locktime <span class="token operator">&lt;=</span> height<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`Too soon to redeem the UTXO. Wait until block </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>locktime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Our locktime is less than or equal to height which means we can redeem</span>

      <span class="token comment">// 2) Prepare redeeming tx</span>

      <span class="token comment">// get index of utxo</span>
      <span class="token keyword">const</span> index <span class="token operator">=</span> lockedTx<span class="token punctuation">.</span>outputs<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span>
        output <span class="token operator">=</span><span class="token operator">></span> output<span class="token punctuation">.</span>address <span class="token operator">===</span> lockingAddr
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// get the coin associated with our locked tx</span>
      <span class="token comment">// indicating the index of the UTXO</span>
      <span class="token keyword">const</span> coinJSON <span class="token operator">=</span> <span class="token keyword">await</span> nodeClient<span class="token punctuation">.</span><span class="token function">getCoin</span><span class="token punctuation">(</span>lockedTx<span class="token punctuation">.</span>hash<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// create a new coin object that references the UTXO we want to spend</span>
      <span class="token comment">// and add it as an input to a blank mutable transaction</span>
      <span class="token keyword">const</span> coin <span class="token operator">=</span> Coin<span class="token punctuation">.</span><span class="token function">fromJSON</span><span class="token punctuation">(</span>coinJSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> mtx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MTX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      mtx<span class="token punctuation">.</span><span class="token function">addCoin</span><span class="token punctuation">(</span>coin<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// For simplicity we'll redeem the locked tx to ourselves</span>
      <span class="token comment">// But if you have another wallet that might be easier</span>
      <span class="token comment">// since you can see the change in balance more easily</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> address <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> wallet<span class="token punctuation">.</span><span class="token function">createAddress</span><span class="token punctuation">(</span><span class="token string">'default'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// send to the address the value of the coin minus the fee</span>
      mtx<span class="token punctuation">.</span><span class="token function">addOutput</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> coin<span class="token punctuation">.</span>value <span class="token operator">-</span> <span class="token number">1500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// set nLocktime field on transaction</span>
      <span class="token comment">// mempool and chain will check against this</span>
      <span class="token comment">// to verify finality for each input</span>
      mtx<span class="token punctuation">.</span><span class="token function">setLocktime</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 3) Setup a keyring to use for signing the input</span>

      <span class="token comment">// First get the script from our saved tx info</span>
      <span class="token keyword">const</span> script <span class="token operator">=</span> Script<span class="token punctuation">.</span><span class="token function">fromRaw</span><span class="token punctuation">(</span>redeemScript<span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Next we'll get the private key associated with the pkh</span>
      <span class="token comment">// that the timelocked UTXO is locked to</span>
      <span class="token comment">// Note it's generally not safe to transfer your private key</span>
      <span class="token comment">// unencrypted over the network like this, but we're doing it</span>
      <span class="token comment">// here for simplicity</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> privateKey <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> wallet<span class="token punctuation">.</span><span class="token function">getWIF</span><span class="token punctuation">(</span>redeemAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> ring <span class="token operator">=</span> KeyRing<span class="token punctuation">.</span><span class="token function">fromSecret</span><span class="token punctuation">(</span>privateKey<span class="token punctuation">,</span> network<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ring<span class="token punctuation">.</span>witness <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      ring<span class="token punctuation">.</span>script<span class="token operator">=</span> script<span class="token punctuation">;</span>

      <span class="token comment">// 4) Script and sign the input</span>
      <span class="token comment">// Note that we can use the same methods as in the mock transaction</span>
      mtx <span class="token operator">=</span> <span class="token function">scriptInput</span><span class="token punctuation">(</span>mtx<span class="token punctuation">,</span> index<span class="token punctuation">,</span> coin<span class="token punctuation">,</span> ring<span class="token punctuation">)</span><span class="token punctuation">;</span>
      mtx <span class="token operator">=</span> <span class="token function">signInput</span><span class="token punctuation">(</span>mtx<span class="token punctuation">,</span> index<span class="token punctuation">,</span> coin<span class="token punctuation">,</span> ring<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 5) Verify and broadcast the tx</span>
      <span class="token comment">// Note that the `verify` won't check against current height</span>
      <span class="token comment">// of the blockchain and the node won't reject the tx but will</span>
      <span class="token comment">// still try and broadcast (you can check your node logs for</span>
      <span class="token comment">// mempool verification errors)</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>mtx<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'MTX did not verify'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> tx <span class="token operator">=</span> mtx<span class="token punctuation">.</span><span class="token function">toTX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>mtx<span class="token punctuation">.</span>view<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'TX did not verify'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> raw <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// now we've got a signed raw transaction that we can broadcast to the network!</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> nodeClient<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>success<span class="token punctuation">,</span> <span class="token string">'There was a problem broadcasting the tx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// confirm the tx is in the mempool</span>
      <span class="token comment">// we need to do this because even if the mempool says there is a problem</span>
      <span class="token comment">// with your transaction, it will try and broadcast anyway</span>
      <span class="token comment">// and result will come back with `success: true`. If it made it into the</span>
      <span class="token comment">// mempool and/or chain and can be queried then you know it was successful</span>
      <span class="token keyword">const</span> txFromHash <span class="token operator">=</span> <span class="token keyword">await</span> nodeClient<span class="token punctuation">.</span><span class="token function">getTX</span><span class="token punctuation">(</span>tx<span class="token punctuation">.</span><span class="token function">rhash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>txFromHash<span class="token punctuation">,</span> <span class="token string">'The tx does not appear to be in the mempool or chain'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Success!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Tx: '</span><span class="token punctuation">,</span> tx<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// if it was successful then we can clear our saved tx info since it is now</span>
      <span class="token comment">// obsolete. Clearing this will re-enable the first evaluation branch above</span>
      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>txInfoPath<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'There was an error with live solution:'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><p>Now you can run <code>lockAndRedeemCLTV</code> once to send the CLTV transaction and again to redeem it
on a live Regtest network! Feel free to play around with the different values to see how it works.
You can use different wallets, change the locktime, or change the redeem amount. Take a look
at the JSON file that is saved after creating the transaction to see what the raw information looks
like that is needed for redeeming.</p>
<h2 id="next-steps">Next Steps</h2><p>What we built in this guide is basically a very basic smart contract that locks funds for
a certain amount of time. This example though can serve as a building block for much more complicated
scripts and contracts. Here are some ideas of other things you can build with CLTV transactions:</p>
<ul>
<li><p><strong><a href="https://en.bitcoin.it/wiki/Hashed_Timelock_Contracts">Hashed Time Locked Contracts</a></strong>-
Aka HTLCs. These are a key part of enabling trustless payment channels in the Lightning Network and
have the time locked script we built here at its base.</p>
</li>
<li><p><strong>Kill Switch Transaction</strong>- You can create an application that uses CLTVs to enforce the condition
where if some action isn&#39;t taken every 6 months (such as pressing a button or sending an email),
a transaction will send all your funds to a multisig address controlled by your estate. You can use a version
of an HTLC to either redeem the tx with your own key or redeem with the multisig account after the time
period. When you take the action, it redeems with your key.</p>
</li>
<li><p><strong>Authorization Levels by Time Lock</strong>- This idea comes from the <a href="https://twitter.com/Bcoin/status/1000098072490262528">Advanced Scripting
chapter</a> in Mastering Bitcoin. The rules of the
transaction would follow this basic structure: &quot;[T]hree partners make decisions based on a majority rule,
so two of the three must agree. However, in the case of a problem with their keys, they want their lawyer
to be able to recover the funds with one of the three partner signatures. Finally, if all partners are
unavailable or incapacitated for a while, they want the lawyer to be able to manage the account directly.&quot;
You can see why they&#39;re called Smart <strong>Contracts</strong>!</p>
</li>
</ul>


					<!-- END OF GUIDE -->
									</div>
								</div>
							</div>
						</div>
					</article>
					<!-- END OF ARTICLE CONTAINER -->

					</div>
					<!-- END BLOG CONTENT -->

					<!-- START SIDEBAR -->
<div class="col-sm-3 sidebar">
  <!-- TEXT WIDGET -->
  <div class="widget">
    <h6 class="montserrat text-uppercase bottom-line">Installation</h6>
      <p>
        <a href="https://github.com/bcoin-org/bcoin/blob/master/docs/getting-started.md">
          See the "Getting Started" guide in the repository documents directory.
        </a>
      </p>
  </div>
  <!-- END TEXT WIDGET -->

  <!-- CATEGORIES WIDGET -->
<div class="widget guide-list">
<h6 class="montserrat text-uppercase bottom-line">Guides</h6>
<ul class="icons-list">
<!-- GUIDES-LIST -->
<li><a href="working-with-txs.html">Working with transactions</a></li>
<li><a href="webapp.html">Building web applications with the bcoin library</a></li>
<li><a href="wallets.html">Wallets and Accounts and Keys, Oh My!</a></li>
<li><a href="swaps.html">Cross-Chain Atomic Swaps</a></li>
<li><a href="segwit.html">Segwit and Bcoin</a></li>
<li><a href="scripting.html">Intro to Scripting</a></li>
<li><a href="op_return.html">Store Data on the Blockchain</a></li>
<li><a href="multisig-tx.html">Creating Multisignature Transactions</a></li>
<li><a href="multisig-cli.html">Multisig on the command line</a></li>
<li><a href="generate-address.html">Generate an Address</a></li>
<li><a href="events.html">Events and Sockets</a></li>
<li><a href="crowdfund-tx.html">Create a Crowdfunding Transaction</a></li>
<li><a href="connect-local-nodes.html">Connect two local nodes</a></li>
<li><a href="cltv.html">Time Locked Bitcoin Transactions w/ CLTV</a></li>
<li><a href="building-plugins.html">Building Awesome bcoin Plugins</a></li>
<li><a href="browser.html">Run a bcoin full node in a web browser</a></li>
<li><a href="bcoin-clock.html">Make your own Bcoin Block Clock!</a></li>
<!-- /GUIDES-LIST -->
</ul>
</div>
  <!-- END CATEGORIES WIDGET -->

  <!-- TEXT WIDGET -->
  <div class="widget">
    <h6 class="montserrat text-uppercase bottom-line">Looking for Docs?</h6>
    <p>Checkout our <a href="../api-docs/index.html">API Docs</a> or the <a href="https://bcoin.io/docs/index.html">Full Documentation</a></p>
  </div>
  <!-- END TEXT WIDGET -->

  <!-- TEXT WIDGET -->
  <div class="widget">
    <h6 class="montserrat text-uppercase bottom-line">Get Involved</h6>
    <p>If you think you've got what it takes to make your own bcoin guides and tutorials, head on over to our <a href="https://github.com/bcoin-org/bcoin-org.github.io">GitHub repo</a> to see how you can make a request or contribute your own and earn bounties! You can also reach out to us on <a href="https://t.me/bcoinorg"> Telegram.</a></p>
  </div>
  <!-- END TEXT WIDGET -->
</div>

					<!-- END SIDEBAR -->

				</div><!-- .row -->

			</div>
		</section>
		<!-- END NEW BLOGS -->

				</div><!-- .row -->

			</div>
		</section>
		<!-- END BLOGS -->


		<!-- PARALLAX DOCS CTA -->
		<section class="module bg-white-alfa-30 parallax color-white" data-background="../assets/images/bg-header.jpg">
			<div class="container">

				<div class="row">
					<div class="col-sm-12">
						<div class="text-center">
							<h2 class="montserrat text-uppercase m-b-30">Ready to start building? Read the docs!</h2>
							<a href="https://bcoin.io/docs/index.html" target="_blank" class="btn btn-lg btn-purple">Documentation</a>
						</div>
					</div>
				</div><!-- .row -->

			</div>
		</section>
		<!-- END PARALLAX DOCS CTA -->

		<!-- FOOTER -->
		<footer id="footer" class="footer-minimal">
			<div class="container">

				<div class="row">
					<div class="col-sm-12">
						<ul class="social-icons social-icons-circle text-center m-b-35">
							<li><a href="https://twitter.com/bcoin"><i class="fa fa-twitter"></i></a></li>
							<li><a href="https://github.com/bcoin-org/bcoin"><i class="fa fa-github"></i></a></li>


							<li><a href="https://t.me/bcoinorg" target="_blank"><img src="assets/images/telegram-app.svg"></a></li>
						</ul>
					</div>
				</div>
				<div class="row">
					<div class="col-sm-12 text-center m-b-35">
						<img class="m-b-35 QR-code" src="../assets/images/donation_QR.png"/>
						<p class="m-0"><strong>Bcoin Development Donation Address:</strong><br />3Bi9H1hzCHWJoFEjc4xzVzEMywi35dyvsV</p>

					</div>
				</div>
				<div class="row">
					<div class="col-sm-12 text-center">
						<p class="m-0">Copyright <a href="#">bcoin.io, Purse</a>, 2018, All Rights Reserved.</p>

					</div>
				</div>

			</div>
		</footer>
		<!-- END FOOTER -->

	</div>
	<!-- /WRAPPER -->

	<!-- JAVASCRIPT FILES -->

	<script src="../assets/js/jquery-2.2.3.min.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?v=3"></script>
	<script src="../assets/bootstrap/js/bootstrap.min.js"></script>
	<script src="../assets/js/plugins.min.js"></script>
	<script src="../assets/js/stickyfill.min.js"></script>
	<script src="../assets/js/custom.min.js"></script>
	<script src="../assets/js/clipboard.min.js"></script>
	<script async defer src="../assets/js/prism.js"></script>
	<script>
		var copyCode = new Clipboard('.copy-button', {
		    target: function(trigger) {
		        return trigger.previousElementSibling;
		    }
		});

		copyCode.on('success', function(event) {
		    event.trigger.classList.add('success');
		    event.clearSelection();
		    // event.trigger.textContent = 'Copied!';
		    window.setTimeout(function() {
		        event.trigger.classList.remove('success');
		    }, 2000);
		});
	</script>

  <!-- github button js -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>

</body>
</html>
