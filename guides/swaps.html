<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="Using the bcoin and bcash libraries, execute a swap of coins between two users
on two chains. Create a Hash Time-Locked Contract to perform the swap securely.">
	<meta name="author" content="Matthew Zipkin, graphics by Darren Mills">

	<title>Bcoin Guide | Cross-Chain Atomic Swaps</title>

	<!-- Favicons -->
	<!-- old
	<link rel="shortcut icon" href="../assets/images/bcoin-ico.png">-->

	<!-- generated from http://www.favicon-generator.org/ -->
	<link rel="apple-touch-icon" sizes="57x57" href="../assets/images/apple-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="../assets/images/apple-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="../assets/images/apple-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="../assets/images/apple-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="../assets/images/apple-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="../assets/images/apple-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="../assets/images/apple-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="../assets/images/apple-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="../assets/images/apple-icon-180x180.png">
	<link rel="icon" type="image/png" sizes="192x192"  href="../assets/images/android-icon-192x192.png">
	<link rel="icon" type="image/png" sizes="32x32" href="../assets/images/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="96x96" href="../assets/images/favicon-96x96.png">
	<link rel="icon" type="image/png" sizes="16x16" href="../assets/images/favicon-16x16.png">
	<link rel="manifest" href="../assets/images/manifest.json">
	<meta name="msapplication-TileColor" content="#ffffff">
	<meta name="msapplication-TileImage" content="../assets/images/ms-icon-144x144.png">
	<meta name="theme-color" content="#ffffff">

	<!-- Web Fonts -->
	<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700' rel='stylesheet'>
	<link href='https://fonts.googleapis.com/css?family=Montserrat:700' rel='stylesheet' type='text/css'>

	<!-- Bootstrap core CSS -->
	<link href="../assets/bootstrap/css/bootstrap.min.css" rel="stylesheet">

	<!-- Code Snippet CSS -->
	<link href="../assets/css/prism.css" rel="stylesheet">

	<link href="../assets/css/custom.css" rel="stylesheet">

	<!-- Icon Fonts -->
	<link href="../assets/css/font-awesome.min.css" rel="stylesheet">
	<link href="../assets/css/simple-line-icons.css" rel="stylesheet">

	<!-- Plugins -->
	<link href="../assets/css/magnific-popup.css" rel="stylesheet">
	<link href="../assets/css/owl.carousel.css" rel="stylesheet">
	<link href="../assets/css/flexslider.css" rel="stylesheet">
	<link href="../assets/css/animate.min.css" rel="stylesheet">

	<!-- Template core CSS -->
	<link href="../assets/css/vertical.min.css" rel="stylesheet">
	<link href="../assets/css/template.css" rel="stylesheet">

	<!-- Google Analytics Tracking -->
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-96446060-1', 'auto');
        ga('send', 'pageview');
    </script>
</head>
<body>

	<!-- PRELOADER -->
	<div class="page-loader">
		<div class="img-loader">Loading...
			<!-- Bcoin logo in SVG -->
			<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
				viewBox="0 0 200 56" style="enable-background:new 0 0 200 56;" xml:space="preserve">
			<g id="XMLID_108_">
				<g id="XMLID_123_">
					<path id="XMLID_124_" d="M8.4,51.8H3.2V4.2h5.2v19.2h0.8c1.2-2,2.8-3.6,4.8-4.7c2-1.1,4.3-1.6,6.7-1.6c2,0,4,0.4,5.8,1.2
						c1.8,0.8,3.4,1.9,4.8,3.3c1.4,1.5,2.5,3.2,3.3,5.4s1.2,4.6,1.2,7.3v1.4c0,2.8-0.4,5.2-1.2,7.4c-0.8,2.1-1.9,3.9-3.3,5.4
						c-1.4,1.5-3,2.6-4.9,3.3s-3.8,1.1-5.9,1.1c-1.1,0-2.2-0.1-3.3-0.4c-1.1-0.3-2.2-0.6-3.2-1.2c-1-0.5-1.9-1.2-2.8-1.9
						c-0.8-0.7-1.6-1.6-2.1-2.7H8.4V51.8z M19.4,47.7c1.6,0,3.1-0.3,4.4-0.9c1.3-0.6,2.5-1.4,3.5-2.4c1-1,1.8-2.3,2.3-3.8
						c0.6-1.5,0.8-3.2,0.8-5v-1.4c0-1.8-0.3-3.5-0.8-4.9c-0.6-1.5-1.3-2.7-2.3-3.8c-1-1.1-2.2-1.9-3.5-2.5c-1.4-0.6-2.8-0.9-4.4-0.9
						c-1.6,0-3,0.3-4.3,0.9c-1.3,0.6-2.5,1.5-3.5,2.6c-1,1.1-1.8,2.4-2.4,3.9c-0.6,1.5-0.9,3.2-0.9,5v0.8c0,1.9,0.3,3.6,0.9,5.1
						c0.6,1.5,1.4,2.8,2.4,3.9s2.2,1.9,3.5,2.5C16.4,47.4,17.9,47.7,19.4,47.7z"/>
				</g>
				<g id="XMLID_120_">
					<path id="XMLID_121_" d="M76.1,39.8c-0.4,1.9-1,3.6-1.8,5.2c-0.9,1.6-2,3-3.3,4.1s-2.9,2.1-4.7,2.7c-1.8,0.6-3.8,1-5.9,1
						c-2.3,0-4.5-0.4-6.6-1.2c-2.1-0.8-3.9-1.9-5.4-3.4c-1.6-1.5-2.8-3.3-3.7-5.4c-0.9-2.1-1.4-4.6-1.4-7.4v-0.8c0-2.7,0.5-5.2,1.4-7.4
						c0.9-2.2,2.1-4,3.7-5.5c1.6-1.5,3.4-2.7,5.4-3.5c2.1-0.8,4.3-1.2,6.6-1.2c2.1,0,4,0.3,5.8,1c1.8,0.6,3.3,1.5,4.7,2.7
						c1.4,1.2,2.5,2.5,3.3,4.1c0.9,1.6,1.5,3.3,1.8,5.2l-5.2,1.2c-0.1-1.2-0.5-2.3-1-3.4c-0.5-1.1-1.2-2.1-2.1-2.9
						c-0.9-0.8-1.9-1.5-3.2-2c-1.2-0.5-2.7-0.7-4.3-0.7c-1.6,0-3.1,0.3-4.5,0.9c-1.4,0.6-2.6,1.5-3.7,2.6c-1.1,1.1-1.9,2.4-2.5,4
						c-0.6,1.5-0.9,3.2-0.9,5v0.8c0,1.9,0.3,3.6,0.9,5.1c0.6,1.5,1.4,2.8,2.5,3.8c1.1,1,2.3,1.8,3.7,2.4c1.4,0.6,3,0.9,4.6,0.9
						s3.1-0.3,4.3-0.8c1.2-0.5,2.3-1.2,3.1-2c0.9-0.8,1.6-1.8,2.1-2.9c0.5-1.1,0.9-2.2,1-3.4L76.1,39.8z"/>
				</g>
				<g id="XMLID_116_">
					<path id="XMLID_117_" d="M117.2,35.4c0,2.8-0.5,5.3-1.4,7.5c-0.9,2.2-2.1,4-3.6,5.4c-1.5,1.5-3.3,2.6-5.3,3.4
						c-2,0.8-4.1,1.2-6.3,1.2c-2.2,0-4.3-0.4-6.3-1.2c-2-0.8-3.8-1.9-5.3-3.4c-1.5-1.5-2.7-3.3-3.6-5.4c-0.9-2.2-1.4-4.6-1.4-7.5v-0.8
						c0-2.8,0.5-5.2,1.4-7.4c0.9-2.2,2.1-4,3.7-5.5c1.5-1.5,3.3-2.6,5.3-3.4c2-0.8,4.1-1.2,6.3-1.2c2.2,0,4.3,0.4,6.3,1.2
						c2,0.8,3.8,1.9,5.3,3.4c1.5,1.5,2.8,3.3,3.7,5.5c0.9,2.2,1.4,4.6,1.4,7.4V35.4z M100.6,47.7c1.6,0,3.1-0.3,4.4-0.9
						c1.4-0.6,2.5-1.4,3.6-2.5c1-1.1,1.8-2.4,2.4-3.9c0.6-1.5,0.9-3.2,0.9-5.1v-0.8c0-1.8-0.3-3.5-0.9-5c-0.6-1.5-1.4-2.8-2.4-3.9
						c-1-1.1-2.2-1.9-3.6-2.6c-1.4-0.6-2.8-0.9-4.4-0.9c-1.6,0-3,0.3-4.4,0.9c-1.4,0.6-2.6,1.5-3.6,2.6c-1,1.1-1.8,2.4-2.4,3.9
						c-0.6,1.5-0.9,3.2-0.9,5v0.8c0,1.9,0.3,3.6,0.9,5.1c0.6,1.5,1.4,2.8,2.4,3.9c1,1.1,2.2,1.9,3.6,2.5C97.5,47.5,99,47.7,100.6,47.7z
						"/>
				</g>
				<g id="XMLID_112_">
					<path id="XMLID_113_" d="M127.6,46.9h11.6V23h-10.4v-4.9h15.6v28.9h10.8v4.9h-27.6V46.9z M137.1,8c0-1.3,0.5-2.4,1.4-3.4
						c0.9-0.9,2-1.4,3.3-1.4c1.3,0,2.4,0.5,3.3,1.4c0.9,0.9,1.4,2.1,1.4,3.4c0,1.3-0.5,2.4-1.4,3.4c-0.9,0.9-2,1.4-3.3,1.4
						c-1.3,0-2.4-0.5-3.3-1.4C137.5,10.4,137.1,9.3,137.1,8z"/>
				</g>
				<g id="XMLID_109_">
					<path id="XMLID_110_" d="M172.8,51.8h-5.2V18.1h5.2v5.7h0.8c2-4.4,5.6-6.7,10.7-6.7c3.8,0,6.9,1.2,9.1,3.6
						c2.3,2.4,3.4,6.1,3.4,10.9v20.2h-5.2V32.8c0-3.5-0.8-6.2-2.3-8c-1.6-1.8-3.7-2.7-6.3-2.7c-3.2,0-5.6,1.1-7.4,3.3s-2.7,5.1-2.7,8.8
						V51.8z"/>
				</g>
			</g>
			</svg>


		</div>
	</div>
	<!-- END PRELOADER -->

	<!-- HEADER -->
	<header class="header js-stick">
			<div class="container">
				<!-- YOUR LOGO HERE -->
				<div class="inner-header">
					<a class="inner-brand" href="../index.html">
						<img class="brand-light" src="../assets/images/logo-light.png" width="100" alt="">
						<img class="brand-dark" src="../assets/images/logo-dark.png" width="100" alt="">
					</a>
				</div>

				<!-- OPEN MOBILE MENU -->
				<div class="main-nav-toggle">
					<div class="nav-icon-toggle" data-toggle="collapse" data-target="#custom-collapse">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</div>
				</div>

				<!-- WIDGETS MENU -->
				<div class="inner-header pull-right hide-me">
					<div class="menu-extras clearfix">

						<!-- TELEGRAM LINK -->
						<div class="menu-item">
							<div class="">
								<a href="https://t.me/bcoinorg" target="_blank" id="" data-toggle="tooltip" title="" data-placement="bottom" data-original-title="Join us on Telegram!">
									<img src="../assets/images/telegram-app.svg" width="18" height="18"/>
									<span class=""></span>
								</a>
                            </div>
						</div>

						<!-- STACK EXCHANGE LINK -->
						<div class="menu-item">
							<div class="">
								<a href="https://bitcoin.stackexchange.com/questions/tagged/bcoin" target="_blank" id="" data-toggle="tooltip" title="" data-placement="bottom" data-original-title="Questions! Checkout Stack Exchange.">
									<img src="../assets/images/stack-exchange-icon.svg" width="18" height="18"/>
									<span class=""></span>
								</a>
                            </div>
						</div>

						<!-- GITHUB STUFF -->
						<div class="menu-item">
							<div class="">
								<a href="https://github.com/bcoin-org/bcoin" target="_blank" id="" data-toggle="tooltip" title="" data-placement="bottom" data-original-title="Visit bcoin on GitHub to see the code!">
									<img src="../assets/images/github_icon.svg" width="18" height="18"/>
									<span class=""></span>
								</a>
                            </div>
						</div>

						<div class="menu-item">
                            <div class="ghbuttons">
                                <a class="github-button" href="https://github.com/bcoin-org/bcoin" data-icon="octicon-star" data-count-href="/bcoin-org/bcoin/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star bcoin-org/bcoin on GitHub">Star</a>
                                <a class="github-button" href="https://github.com/bcoin-org/bcoin/fork" data-icon="octicon-repo-forked" data-count-href="/bcoin-org/bcoin/network" data-show-count="true" data-count-aria-label="# forks on GitHub" aria-label="Fork bcoin-org/bcoin on GitHub">Fork</a>
                            </div>
                        </div>




					</div>
				</div>

				<!-- MAIN MENU -->
				<nav id="custom-collapse" class="main-nav collapse clearfix">
					<ul class="inner-nav pull-right">

						<!-- HOME -->
						<li><a href="../index.html">Home</a></li>
						<!-- END HOME -->

						<!-- FEATURES -->
						<li><a href="../index.html#features">What is Bcoin</a></li>
						<!-- END FEATURES -->

						<!-- GUIDES -->
						<li><a href="../guides.html">Guides</a></li>
						<!-- GUIDES -->

						<!-- API REFERENCE - newer, how to interact once you're setup -->
						<li><a href="../api-docs/index.html">API Docs</a></li>
						<!-- END API -->

						<!-- FULL DOCS - older, full reference
						<li><a href="https://bcoin.io/docs/index.html">Docs</a></li> -->
						<!-- END DOCS -->

						<!-- DIVIDER
						<li><a>&nbsp;</a></li>

						<li><a href="#">All Demos</a></li>-->

					</ul>
				</nav>

			</div>
		</header>
	<!-- END HEADER -->

	<!-- WRAPPER -->
	<div class="wrapper">

		<!-- PAGE TITLE -->
		<section class="module-sm bg-white-dark" data-background="../assets/images/bg-header.jpg">
			<div class="container">

				<div class="row">
					<div class="col-sm-12 text-center">

						<h2 class="montserrat text-uppercase m-b-10"><span class="text-highlight-black" style="line-height: 1.5;">&nbsp;Guides &nbsp;and &nbsp;Videos&nbsp;</span></h2>

					</div>
				</div>

			</div>
		</section>
		<!-- END PAGE TITLE -->

		<!-- GUIDES/TUTORIALS -->
		<section class="module" style="padding-top:70px !important;">
			<div class="container">

				<div class="row">
					<!-- START OF ARTICLE CONTAINER -->
					<div class="col-sm-9 blog-content post-thumbnail">
						<!-- POST IMAGE -->
						<article class="post format-image">
							<div class="row">
								<!--<div class="col-sm-5">
									<div class="post-preview">
										<a href="#"><img src="../assets/images/guides/get-started.png" alt=""></a>
									</div>
								</div>-->

								<!-- after re-enabling the above code, change the col-sm below to col-sm-7 -->
								<div class="panel-group">
									<div class="col-sm-12 panel panel-default">
										<div class="post-content" style="color:#000;">
					<!-- START OF GUIDE -->
<h2 class="post-title panel-title" id="crosschain-atomic-swaps">Cross-Chain Atomic Swaps</h2><ul class="post-meta"><li class="author">By Matthew Zipkin, graphics by Darren Mills</li></ul><h2 id="what-are-crosschain-atomic-swaps?">What are cross-chain atomic swaps?</h2><p>A cross-chain atomic swap is method of exchanging different cryptocurrencies directly between two peers.
Like trading dollars for pesos, it&#39;s a process in which two people can exchange one cryptocurrency for
another, but without trust or third-party moderation. We say the swaps are &quot;atomic&quot; because they must be
<a href="https://en.wikipedia.org/wiki/Atomicity_(database_systems)">all-or-nothing.</a>
To protect both users, there must be no scenario in which one person can control both coins at the same time.</p>
<p>Atomic swaps can be executed between many blockchains, but not all. For the scheme to work, both
chains need some kind of relative timelock operation (like <code>OP_CHECKSEQUENCEVERIFY</code>), as well as the ability
to hash a blob of data and check against a given hash. In this guide we&#39;ll
be focusing on just Bitcoin and Bitcoin Cash, using the <a href="https://github.com/bcoin-org/bcoin">bcoin</a>
and <a href="https://github.com/bcoin-org/bcash">bcash</a> libraries respectively. It&#39;s a bit of
a game: the rules can&#39;t be broken, but you still have to pay attention. The magic
machine at the core of the atomic swap is called the Hash Time-Locked Contract, or HTLC.</p>
<h2 id="htlcs">HTLCs</h2><p style="text-align:center"><img src="../assets/images/guides/swap1.png"></p>

<p>Blockchains are like a stack of locked mailboxes with deposit slots. When you want to receive Bitcoin
from someone, you tell them which mailbox to put the coin into.</p>
<p style="text-align:center"><img src="../assets/images/guides/swap2.png"></p>

<p>Bob decides to pay Alice. He puts 0.5 BTC in the slot of Mailbox “A” which is locked by Lock “A”. When
Alice is ready to spend the coin or move it somewhere else, she uses her Key “A” to open the lock and
take out the coin.</p>
<p>HTLCs are more complicated. First of all, they have TWO locks, and EITHER lock can open the mailbox and
expose the coin. They also use much fancier locks than usual.</p>
<img src="../assets/images/guides/swap3t.png" style="float:left">

<h3 id="time-locks">TIME LOCKS</h3><p>Time locks still require the right key but they ALSO require a certain amount of time to pass. Even if
you have the key for this lock, you still need to wait until the time “expires” before you can open it.</p>
<br>
<img src="../assets/images/guides/swap3h.png" style="float:right">

<h3 id="hash-locks">HASH LOCKS</h3><p>Hash locks require the right key but they ALSO require a SECRET CODE to be entered, like the PIN on an ATM.
Even if you have the key for this lock, you also need to enter the right code to open it. When you enter
the secret code, it is visible for the entire world to see, like the screen on a calculator.</p>
<h2 id="let#39;s-swap!">Let&#39;s swap!</h2><p>For now we’ll ignore the time locks, but just keep in mind they are there. In an ideal situation, only
the hash locks are used anyway. As we&#39;ll see later on, the time locks are only used as refunds in order
to cancel the swap. Let’s say Alice wants Bitcoin and Bob wants Bitcoin Cash. They agree to
swap the coins they have for the coins they want.</p>
<p style="text-align:center"><img src="../assets/images/guides/swap4.png"></p>

<p>Alice makes two hash locks, that both require the EXACT SAME secret code. However, one requires her Key “A”
but the other requires Bob’s Key “B”. Alice knows the secret code but keeps it a secret for now.</p>
<p style="text-align:center"><img src="../assets/images/guides/swap5.png"></p>

<p>Alice puts Hash Lock “A” on a Bitcoin mailbox, and Hash Lock “B” on a Bitcoin Cash mailbox. Alice deposits
her Bitcoin Cash into Mailbox “B” and Bob deposits his Bitcoin into Mailbox “A”. </p>
<h3 id="magic-time">MAGIC TIME!</h3><p style="text-align:center"><img src="../assets/images/guides/swap6.png"></p>

<p>Once the coins are both deposited, Alice goes over to Bitcoin Mailbox “A”. She puts in her Key “A” and
enters the secret code she came up with earlier. With the key and the code entered, the mailbox is
opened and she can acquire the Bitcoin. Meanwhile, Bob is watching Bitcoin Mailbox “A” and SEES ALICE ENTER
HER SECRET CODE. Now Bob knows the code too! He goes over to Bitcoin Cash Mailbox “B”, puts in his Key “B”
and enters the secret code he JUST LEARNED from watching Alice. Voila! Bob opens Bitcoin Cash Mailbox “B”
and the coin is his. Alice and Bob have just successfully swapped coins on two separate blockchains without
ever trusting each other or any third-party.</p>
<h3 id="but-what-if-things-don’t-go-according-to-plan">But what if things don’t go according to plan?</h3><p>Let’s say Bob put his Bitcoin into Mailbox “A” but then never heard from Alice again. If she doesn’t enter
her secret code, Bob can’t get the Bitcoin Cash he wanted. Bob needs a way to get his original Bitcoin BACK
if Alice doesn’t participate. This is where the time locks come in.</p>
<p>The time locks allow both parties to refund themselves in case the swap does not succeed as planned. The
reason we use time locks for this is to eliminate the possibility that one person ends up with both coins,
leaving the other person with nothing. When the locks are put on the HTLC mailboxes, the time locks are set
to give each counterparty a chance to redeem the swap without interference. If the swap never happens,
everyone can take back the coins they started with after the time expires.</p>
<p style="text-align:center"><img src="../assets/images/guides/swap7.png"></p>

<p>The length of time on each lock is important to ensure that the game can only be played fairly. In our story,
Alice’s time lock should be longer (say like a week) and Bob’s lock should be much shorter (like a day).
Broadly speaking this is because Alice knows the hash lock secret and therefore has a major advantage. The
game doesn’t really begin until she reveals her secret code so we make her refund much more cumbersome. If
Bob thinks Alice is going to flake out, he can refund his Bitcoin from Mailbox “A” long before Alice can
refund her Bitcoin Cash from Mailbox “B”. </p>
<p>To illustrate why this is important, consider if the times were reversed. If Mailbox “B” had the shorter
refund time, Alice could wait until that time expires, refund herself the Bitcoin Cash from Mailbox “B”
AND THEN ALSO enter the secret code into Bitcoin Mailbox “A” and take the Bitcoin that Bob sent.
Alice would have all the money and Bob would be broke!</p>
<p><a name="scripts"></a></p>
<h2 id="scripts">Scripts</h2><p>Now it&#39;s time to turn these &quot;two-lock mailboxes&quot; into actual Bitcoin transactions. For this guide we
will describe a very simple method of constructing and executing smart contracts that sacrifice some
privacy and potentially some security. It is not recommended these be used <em>as is</em> in production.
For details on how the implementation can be improved, see <a href="#next-steps">next steps</a> below.</p>
<p>This will be the redeem script in the output of our Hash Time-Locked Contract:</p>
<pre class="snippet line-numbers language-bash "><code class="line-numbers language-bash">OP_IF
  OP_SHA256
  <span class="token operator">&lt;</span>hash of secret<span class="token operator">></span>
  OP_EQUALVERIFY
  <span class="token operator">&lt;</span>pubKey of swap<span class="token operator">></span>
  OP_CHECKSIG
OP_ELSE
  <span class="token operator">&lt;</span>relative locktime<span class="token operator">></span>
  OP_CHECKSEQUENCEVERIFY
  OP_DROP
  <span class="token operator">&lt;</span>pubKey of refund<span class="token operator">></span>
  OP_CHECKSIG
OP_ENDIF</code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><p>The Hash Lock is the first section of the script, executed when <code>OP_IF</code> reads a <code>true</code> value from the stack.
It expects a secret value and an ECDSA signature. It hashes the secret and checks that it matches a given hash,
then it checks the signature against the given public key. To redeem the HTLC this way, we will use the following
script in the input of a transaction:</p>
<pre class="snippet line-numbers language-bash "><code class="line-numbers language-bash"><span class="token operator">&lt;</span>signature of swap<span class="token operator">></span>
<span class="token operator">&lt;</span>secret value<span class="token operator">></span>
<span class="token operator">&lt;</span>true<span class="token operator">></span></code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><p>Keep in mind that the stack is <a href="https://en.wikipedia.org/wiki/Stack_(abstract_data_type)">first-in / last-out</a>,
so if this input script looks &quot;upside-down&quot; that&#39;s because the last element will end up being on the top of the
stack when the redeem script is run.</p>
<p>The time lock is executed when <code>OP_IF</code> gets a <code>false</code> value. This causes script execution to skip all OP codes
until it finds <code>OP_ELSE</code>, where it continues processing up to <code>OP_ENDIF</code>. The time lock will only be checked when <code>if (false)</code>.</p>
<p>First it executes a <a href="https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch07.asciidoc#relative-timelocks">Check Sequence Verify</a>
routine, which fails if the given relative locktime has not yet passed. Then it simply checks a signature
against a given public key like usual. To redeem the transaction with this path, we will use this input script:</p>
<pre class="snippet line-numbers language-bash "><code class="line-numbers language-bash"><span class="token operator">&lt;</span>signature of refund<span class="token operator">></span>
<span class="token operator">&lt;</span>false<span class="token operator">></span></code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><h2 id="creating-htlc-scripts-with-bcoin-and-bcash">Creating HTLC scripts with bcoin and bcash</h2><p>The <code>bcoin</code> and <code>bcash</code> libraries are so similar that we can use the exact same commands
to create HTLCs on both chains, and build a working application with wallets. A finished package
can be found at <a href="https://github.com/pinheadmz/swap-test">https://github.com/pinheadmz/swap-test</a>. First, we&#39;ll
review the <code>Swap</code> class in <code>lib/swap.js</code> that is able to build scripts, addresses, and transactions
on any compatible library passed to it. With almost no conditionals, we can make this library completely
chain-agnostic.</p>
<pre class="snippet line-numbers language-javascript "><code class="line-numbers language-javascript"><span class="token comment">// lib/swap.js</span>

<span class="token keyword">class</span> <span class="token class-name">Swap</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span> network<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// Require the library by name and set the network for every module</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>libName <span class="token operator">=</span> lib<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lib <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>lib<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lib<span class="token punctuation">.</span>Network<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>network<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Import each module we'll need from the library</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>Outpoint <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lib<span class="token punctuation">.</span>Outpoint<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>Coin <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lib<span class="token punctuation">.</span>Coin<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>MTX <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lib<span class="token punctuation">.</span>MTX<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>TX <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lib<span class="token punctuation">.</span>TX<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>Address <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lib<span class="token punctuation">.</span>Address<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hd <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lib<span class="token punctuation">.</span>hd<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>KeyRing <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lib<span class="token punctuation">.</span>KeyRing<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>Script <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lib<span class="token punctuation">.</span>Script<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>Stack <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lib<span class="token punctuation">.</span>Stack<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>consensus <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lib<span class="token punctuation">.</span>consensus<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>util <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lib<span class="token punctuation">.</span>util<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ChainEntry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lib<span class="token punctuation">.</span>ChainEntry<span class="token punctuation">;</span>

    <span class="token comment">// Verify things like SegWit, CSV, Bitcoin Cash FORKID, etc.</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>flags <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Script<span class="token punctuation">.</span>flags<span class="token punctuation">.</span>STANDARD_VERIFY_FLAGS<span class="token punctuation">;</span>

    <span class="token comment">// We will base our relative locktime on TIME, not BLOCKS</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>CSV_seconds <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span></code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><p>For example, observe how creating a new object with <code>new Swap(&#39;bcoin&#39;, &#39;testnet&#39;)</code> would
give us the specific <code>Address</code> module for making Bitcoin addresses. We could create a second object for
<code>bcash</code> that would, with the exact same line of code, give us the module for Bitcoin Cash addresses.</p>
<p><em>SWEET.</em></p>
<p>The next three functions we&#39;ll need will compile our Bitcoin scripts from the last section into
the actual byte code used in serialized transactions on the network. To learn more about working with scripts,
check out the bcoin.io guides <a href="scripting.html">Intro to Scripting</a> and the more advanced
<a href="cltv.html">Time Locked Bitcoin Transactions w/ CLTV</a>.</p>
<pre class="snippet line-numbers language-javascript "><code class="line-numbers language-javascript"><span class="token comment">// lib/swap.js</span>

<span class="token keyword">class</span> <span class="token class-name">Swap</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">// REDEEM script: the output of the swap HTLC</span>
  <span class="token function">getRedeemScript</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> refundPubkey<span class="token punctuation">,</span> swapPubkey<span class="token punctuation">,</span> locktime<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> redeem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">this<span class="token punctuation">.</span>Script</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    redeem<span class="token punctuation">.</span><span class="token function">pushSym</span><span class="token punctuation">(</span><span class="token string">'OP_IF'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redeem<span class="token punctuation">.</span><span class="token function">pushSym</span><span class="token punctuation">(</span><span class="token string">'OP_SHA256'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redeem<span class="token punctuation">.</span><span class="token function">pushData</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
    redeem<span class="token punctuation">.</span><span class="token function">pushSym</span><span class="token punctuation">(</span><span class="token string">'OP_EQUALVERIFY'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redeem<span class="token punctuation">.</span><span class="token function">pushData</span><span class="token punctuation">(</span>swapPubkey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    redeem<span class="token punctuation">.</span><span class="token function">pushSym</span><span class="token punctuation">(</span><span class="token string">'OP_CHECKSIG'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redeem<span class="token punctuation">.</span><span class="token function">pushSym</span><span class="token punctuation">(</span><span class="token string">'OP_ELSE'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redeem<span class="token punctuation">.</span><span class="token function">pushInt</span><span class="token punctuation">(</span>locktime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    redeem<span class="token punctuation">.</span><span class="token function">pushSym</span><span class="token punctuation">(</span><span class="token string">'OP_CHECKSEQUENCEVERIFY'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redeem<span class="token punctuation">.</span><span class="token function">pushSym</span><span class="token punctuation">(</span><span class="token string">'OP_DROP'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redeem<span class="token punctuation">.</span><span class="token function">pushData</span><span class="token punctuation">(</span>refundPubkey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    redeem<span class="token punctuation">.</span><span class="token function">pushSym</span><span class="token punctuation">(</span><span class="token string">'OP_CHECKSIG'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redeem<span class="token punctuation">.</span><span class="token function">pushSym</span><span class="token punctuation">(</span><span class="token string">'OP_ENDIF'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    redeem<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> redeem<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// SWAP script: used by counterparty to open the hash lock </span>
  <span class="token function">getSwapInputScript</span><span class="token punctuation">(</span>redeemScript<span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> inputSwap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">this<span class="token punctuation">.</span>Script</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    inputSwap<span class="token punctuation">.</span><span class="token function">pushInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// signature placeholder</span>
    inputSwap<span class="token punctuation">.</span><span class="token function">pushData</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    inputSwap<span class="token punctuation">.</span><span class="token function">pushInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;true></span>
    inputSwap<span class="token punctuation">.</span><span class="token function">pushData</span><span class="token punctuation">(</span>redeemScript<span class="token punctuation">.</span><span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// P2SH</span>
    inputSwap<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> inputSwap<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// REFUND script: used by original sender of funds to open time lock</span>
  <span class="token function">getRefundInputScript</span><span class="token punctuation">(</span>redeemScript<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> inputRefund <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">this<span class="token punctuation">.</span>Script</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    inputRefund<span class="token punctuation">.</span><span class="token function">pushInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// signature placeholder</span>
    inputRefund<span class="token punctuation">.</span><span class="token function">pushInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;false></span>
    inputRefund<span class="token punctuation">.</span><span class="token function">pushData</span><span class="token punctuation">(</span>redeemScript<span class="token punctuation">.</span><span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// P2SH</span>
    inputRefund<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> inputRefund<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><p>You might notice there are two extra lines marked with <code>// P2SH</code> that you didn&#39;t see in the input scripts
section above. This is required by the mechanics of Pay-To-Script-Hash transactions. The transaction output
we are spending from contains only a hash of the redeem script. The actual redeem script itself is provided
by the input scripts at the time the coin is being spent, so they are included here.</p>
<p>The lines marked <code>// signature placeholder</code> are required before the transaction is signed. The laws of the finite
universe prevent us from signing a message that already contains its own signature, and the
<a href="https://en.bitcoin.it/wiki/OP_CHECKSIG">Bitcoin Protocol</a> therefore expects the signatures to be removed
from a transaction script during verification. Eventually we will sign our transactions with these <code>Int(0)</code>&#39;s
in the scripts, then replace them with the final signatures for broadcasting to the network.</p>
<h2 id="funding-the-swap">Funding the swap</h2><p>This is an easy process. We have our HTLC redeem script ready to go, we just need to turn that into
a P2SH address, and send some coins! This is where the similarity between libraries is crucial. For
both networks, we can generate valid P2SH addresses using the same function:</p>
<pre class="snippet line-numbers language-javascript "><code class="line-numbers language-javascript"><span class="token comment">// lib/swap.js</span>

<span class="token keyword">class</span> <span class="token class-name">Swap</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token function">getAddressFromRedeemScript</span><span class="token punctuation">(</span>redeemScript<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// P2SH wrapper around 160-bit hash of serialized redeem script</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Address<span class="token punctuation">.</span><span class="token function">fromScripthash</span><span class="token punctuation">(</span>redeemScript<span class="token punctuation">.</span><span class="token function">hash160</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><p>On testnet, using two different instances of our <code>Swap</code> class, this function will give us the
following example addresses:</p>
<div class="terminal">2NDeKm7Yu3Z4HoRn7qVkead8trTKG8y3RQE # Bitcoin
bchtest:pppj5wmjdqj6mxc8yfz2vfsrzdvqpsjctu0pu5wus3 # Bitcoin Cash</div>

<h2 id="redeeming-the-swap">Redeeming the swap</h2><p>Once funds are sent to the P2SH addresses, we can spend them using either the <code>swap</code> or
<code>refund</code> input scripts. We have already generated the scripts so we just need to create a transaction
and sign it! Generating the signatures is handled entirely by the <code>TX</code> module in each library:</p>
<pre class="snippet line-numbers language-javascript "><code class="line-numbers language-javascript"><span class="token comment">// lib/swap.js</span>

<span class="token keyword">class</span> <span class="token class-name">Swap</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token function">signInput</span><span class="token punctuation">(</span>
    mtx<span class="token punctuation">,</span>
    index<span class="token punctuation">,</span>
    redeemScript<span class="token punctuation">,</span>
    value<span class="token punctuation">,</span>
    privateKey<span class="token punctuation">,</span>
    sigHashType<span class="token punctuation">,</span>
    version_or_flags
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">return</span> mtx<span class="token punctuation">.</span><span class="token function">signature</span><span class="token punctuation">(</span>
      index<span class="token punctuation">,</span>
      redeemScript<span class="token punctuation">,</span>
      value<span class="token punctuation">,</span>
      privateKey<span class="token punctuation">,</span>
      sigHashType<span class="token punctuation">,</span>
      version_or_flags
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><p>Uhh... what the heck is <code>version_or_flags</code>? Ok, here we finally have some divergence between
<code>bcoin</code> and <code>bcash</code>. In the <code>tx.signature()</code> function, <code>bcoin</code> expects a <code>version</code> integer to select either
legacy or <a href="https://github.com/bitcoin/bips/blob/master/bip-0143.mediawiki#specification">SegWit serialization</a>
for signing. Since Bitcoin Cash does not have any SegWit features at all, this parameter is instead used
to pass additional SigHash flags used for
<a href="https://github.com/Bitcoin-ABC/bitcoin-abc/blob/master/doc/abc/replay-protected-sighash.md">replay protection at the time of the hard fork.</a></p>
<p>Due to a similar inconsistency, we will need to pass different values for <code>sigHashType</code> depending on 
which chain we are constructing transactions for. With those disclaimers behind us, let&#39;s build the transaction!
The following function puts together all the pieces to complete the swap. For more detail on how these <code>MTX</code>
methods work, see the bcoin.io guide <a href="working-with-txs.html">Working with transactions</a>.</p>
<pre class="snippet line-numbers language-javascript "><code class="line-numbers language-javascript"><span class="token comment">// lib/swap.js</span>

<span class="token keyword">class</span> <span class="token class-name">Swap</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">// Works for both refund and swap</span>
  <span class="token function">getRedeemTX</span><span class="token punctuation">(</span>
    address<span class="token punctuation">,</span>
    fee<span class="token punctuation">,</span>
    fundingTX<span class="token punctuation">,</span>
    fundingTXoutput<span class="token punctuation">,</span>
    redeemScript<span class="token punctuation">,</span>
    inputScript<span class="token punctuation">,</span>
    locktime<span class="token punctuation">,</span>
    privateKey
  <span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token comment">// Create a mutable transaction object</span>
    <span class="token keyword">const</span> redeemTX <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">this<span class="token punctuation">.</span>MTX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Get the output we want to spend (coins sent to the P2SH address) </span>
    <span class="token keyword">const</span> coin <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Coin<span class="token punctuation">.</span><span class="token function">fromTX</span><span class="token punctuation">(</span>fundingTX<span class="token punctuation">,</span> fundingTXoutput<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add that coin as an input to our transaction</span>
    redeemTX<span class="token punctuation">.</span><span class="token function">addCoin</span><span class="token punctuation">(</span>coin<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Redeem the input coin with either the swap or refund script</span>
    redeemTX<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>script <span class="token operator">=</span> inputScript<span class="token punctuation">;</span>

    <span class="token comment">// Create the output back to our primary wallet</span>
    redeemTX<span class="token punctuation">.</span><span class="token function">addOutput</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      address<span class="token punctuation">:</span> address<span class="token punctuation">,</span>
      value<span class="token punctuation">:</span> coin<span class="token punctuation">.</span>value <span class="token operator">-</span> fee
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// If this was a refund redemption we need to set the sequence</span>
    <span class="token comment">// Sequence is the relative timelock value applied to individual inputs</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>locktime<span class="token punctuation">)</span>
      redeemTX<span class="token punctuation">.</span><span class="token function">setSequence</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> locktime<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>CSV_seconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      redeemTX<span class="token punctuation">.</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sequence <span class="token operator">=</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span>

    <span class="token comment">// Set SIGHASH and replay protection bits</span>
    <span class="token keyword">let</span> version_or_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> type <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>libName <span class="token operator">===</span> <span class="token string">'bcash'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      version_or_flags <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flags<span class="token punctuation">;</span>
      type <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Script<span class="token punctuation">.</span>hashType<span class="token punctuation">.</span>SIGHASH_FORKID <span class="token operator">|</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Script<span class="token punctuation">.</span>hashType<span class="token punctuation">.</span>ALL<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>

    <span class="token comment">// Create the signature authorizing the input script to spend the coin</span>
    <span class="token keyword">const</span> sig <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">signInput</span><span class="token punctuation">(</span>
      redeemTX<span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span>
      redeemScript<span class="token punctuation">,</span>
      coin<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
      privateKey<span class="token punctuation">,</span>
      type<span class="token punctuation">,</span>
      version_or_flags
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Insert the signature into the input script where we had a `0` placeholder</span>
    inputScript<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> sig<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Finish up and return</span>
    inputScript<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> redeemTX<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><p>Once we&#39;ve completed and signed the transaction, we can test that it verifies
against the network rules:</p>
<pre class="snippet line-numbers language-javascript "><code class="line-numbers language-javascript"><span class="token comment">// lib/swap.js</span>

<span class="token keyword">class</span> <span class="token class-name">Swap</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token function">verifyMTX</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> mtx<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>flags<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><h2 id="agreeing-on-and-executing-a-swap">Agreeing on and executing a swap</h2><p>Now that we have all the tools, you might be asking yourself <a href="https://youtu.be/i7wnagAyqvc?t=2507">&quot;What is the minimum amount of information
two parties need to send each other to engage in a swap?&quot;</a> This is where
some additional crypto-magic comes in to play. It turns out that besides the exchange rate and volume, the only thing the two trading partners need to exchange is:</p>
<ol>
<li>One ECDSA public key from each party</li>
<li>A hashed secret from one party</li>
</ol>
<p>Using these data and the scripting functions from the last section, both parties can deterministically derive
the P2SH addresses for the contracts on both chains. By watching for transactions in and out of those addresses
on both chains, everyone will have everything they need to play the atomic swap game.</p>
<p>We can add two simple functions to generate these data, using the <a href="https://github.com/bcoin-org/bcrypto">bcrypto</a> module as a utility:</p>
<pre class="snippet line-numbers language-javascript "><code class="line-numbers language-javascript"><span class="token comment">// lib/swap.js</span>

<span class="token keyword">class</span> <span class="token class-name">Swap</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment">// Generate a random secret and derive its SHA-256 hash</span>
  <span class="token function">getSecret</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    secret <span class="token operator">=</span> bcrypto<span class="token punctuation">.</span>random<span class="token punctuation">.</span><span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> hash <span class="token operator">=</span> bcrypto<span class="token punctuation">.</span>SHA256<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token string">'secret'</span><span class="token punctuation">:</span> secret<span class="token punctuation">,</span>
      <span class="token string">'hash'</span><span class="token punctuation">:</span> hash
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Generate an ECDSA public / private key pair</span>
  <span class="token function">getKeyPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// Generate new random private key</span>
    <span class="token keyword">const</span> master <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hd<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> master<span class="token punctuation">.</span><span class="token function">derivePath</span><span class="token punctuation">(</span><span class="token string">'m/44/0/0/0/0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    privateKey <span class="token operator">=</span> key<span class="token punctuation">.</span>privateKey<span class="token punctuation">;</span>

    <span class="token comment">// Derive public key from private key</span>
    <span class="token keyword">const</span> keyring <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>KeyRing<span class="token punctuation">.</span><span class="token function">fromPrivate</span><span class="token punctuation">(</span>privateKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> publicKey <span class="token operator">=</span> keyring<span class="token punctuation">.</span>publicKey<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token string">'publicKey'</span><span class="token punctuation">:</span> publicKey<span class="token punctuation">,</span>
      <span class="token string">'privateKey'</span><span class="token punctuation">:</span> privateKey<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><p>They key exchange method is up to the users on the application layer. They could save a little space
by agreeing on a protocol in advance. We can imagine preset, hard-coded locktimes and perhaps
a common exchange rate API. In my demonstration repository, I have a script <code>app/prep-swap.js</code> that imports
the <a href="https://github.com/bcoin-org/bstring">bstring</a> module and encodes the keys into base58
strings which Alice and Bob can send each other:</p>
<pre class="snippet line-numbers language-javascript "><code class="line-numbers language-javascript"><span class="token comment">// app/prep-swap.js</span>

<span class="token comment">/*
 * Create parameters for swap
 */</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>base58<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bstring'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Swap <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../lib/swap'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> swap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Swap</span><span class="token punctuation">(</span><span class="token string">'bcoin'</span><span class="token punctuation">,</span> <span class="token string">'testnet'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// could be any library for this step</span>
<span class="token keyword">const</span> secret <span class="token operator">=</span> swap<span class="token punctuation">.</span><span class="token function">getSecret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> keys <span class="token operator">=</span> swap<span class="token punctuation">.</span><span class="token function">getKeyPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> pub <span class="token operator">=</span> <span class="token punctuation">{</span>
  hash<span class="token punctuation">:</span> secret<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  publicKey<span class="token punctuation">:</span> keys<span class="token punctuation">.</span>publicKey<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> priv <span class="token operator">=</span> <span class="token punctuation">{</span>
  secret<span class="token punctuation">:</span> secret<span class="token punctuation">.</span>secret<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  privateKey<span class="token punctuation">:</span> keys<span class="token punctuation">.</span>privateKey<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> pubBase58 <span class="token operator">=</span> base58<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>pub<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> privBase58 <span class="token operator">=</span> base58<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>priv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'\n --- \n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'PUBLIC: send to counterparty:\n'</span><span class="token punctuation">,</span> pubBase58<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'\n --- \n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'PRIVATE: keep safe and pass to run script:\n'</span><span class="token punctuation">,</span> privBase58<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'\n --- \n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><p>Running the script above with the command <code>node app/prep-swap.js</code> returns output like this:</p>
<div class="terminal" style="word"> --- 

<p>PUBLIC: send to counterparty:
 aBH1zNWHWMbrDca59P4stUUw4XfW3vv25AidWFnfjLh4icanECVq4FAZRtQutddZr6VEM5a5KQtp93
 EA3jvZ3o5ViPXTW8E1kKDaZiZPxUxp8rxmg8mnqNW2s7qh5JasyrYnTAyensNQhAAUP4cwhyHRYvmV
 mhbMqRLU9DTi1nKdMGfpBu7MfjNGnpBZ2WdiSQiiopQgwXQaTBKYhS7Fr</p>
<hr>
<p>PRIVATE: keep safe and pass to run script:
 3XSNNNHE27JLQFY9FAKHDra2u1RUocFGgw1fAxrNJw3gmXqZdPLBpbpqZ8nWNw2stCS7DuGCuPqLPq
 M3ivxQhRJkSDa2PukPxAcHKV6HNZK1jQx57EKF523KqSLgNuKMEYF7U1YrPYe5CKMX2wgLDL2W763G
 ikdcJtzKsKH8KnuKSVSy3FVBsLtixPFKsfgrEvhQ9QsqgHzJz3MomLNdrkC</p>
<p> --- </div></p>
<h2 id="using-the-blockchain-to-communicate">Using the blockchain to communicate</h2><p>Remember, part of the swap protocol involves Alice revealing her secret value to Bob. That is
done on the blockchain, so Bob needs to watch the chain for Alice&#39;s redemption transaction
and pull the secret value out of it somehow. Since we know the exact structure of Alice&#39;s
<a href="#scripts">input script</a> we can expect her secret to be the second value in the script.
Once we catch Alice&#39;s transaction we need to figure out which input is redeeming the swap,
then grab the secret. We discover the input by looking for the P2SH address we derived earlier.</p>
<pre class="snippet line-numbers language-javascript "><code class="line-numbers language-javascript"><span class="token comment">// lib/swap.js</span>

<span class="token keyword">class</span> <span class="token class-name">Swap</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token function">extractSecret</span><span class="token punctuation">(</span>tx<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// Find the input that spends from the P2SH address</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> input <span class="token keyword">of</span> tx<span class="token punctuation">.</span>inputs<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">const</span> inputJSON <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> inAddr <span class="token operator">=</span> inputJSON<span class="token punctuation">.</span>address<span class="token punctuation">;</span>
      <span class="token comment">// Once we find it, return the second script item (the secret)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>inAddr <span class="token operator">===</span> address<span class="token punctuation">)</span>
        <span class="token keyword">return</span> input<span class="token punctuation">.</span>script<span class="token punctuation">.</span>code<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><h2 id="watchonly-wallets-and-events">Watch-only wallets and events</h2><p>The last mechanism we need to make a functional atomic swap application is a wallet, or
several wallets. Refer to the bcoin.io guide <a href="events.html">Events and Sockets</a>
for more background on events and &quot;joining wallets&quot; with websockets. </p>
<p>To run an atomic swap with bcoin and bcash, an application will run four servers:</p>
<ul>
<li>bcoin node</li>
<li>bcoin wallet</li>
<li>bcash node</li>
<li>bcash wallet</li>
</ul>
<p>You can see my design in <code>app/run-swap.js</code> in the 
<a href="https://github.com/pinheadmz/swap-test">completed repository</a>. Notice the 
<a href="https://github.com/pinheadmz/swap-test#configuration">configuration</a> section of the README
which lists the port numbers for each server.</p>
<p>For brevity, we&#39;ll just review the last step in our swap story: Bob extracting the HTLC
secret from Alice&#39;s Bitcoin Cash sweep-transaction and using it to sweep his own Bitcoin
transaction. Keep in mind that by the time the following code is run, Bob has already deposited
BTC into the swap address for Alice to sweep. The code is presented linearly here but in
the actual application it is organized a bit differently.</p>
<p>We assume the application has already constructed <code>BTC_Swap</code> and <code>BCH_Swap</code> objects,
as well as <code>BTC_WalletClient</code>, <code>BCH_WalletClient</code>, <code>BTC_NodeClient</code> and <code>BCH_NodeClient</code>.</p>
<pre class="snippet line-numbers language-javascript "><code class="line-numbers language-javascript"><span class="token comment">// app/run-swap.js</span>

<span class="token comment">// Derive the redeem script</span>
<span class="token keyword">const</span> BTC_RedeemScript <span class="token operator">=</span> Swap<span class="token punctuation">.</span><span class="token function">getRedeemScript</span><span class="token punctuation">(</span>
  hash<span class="token punctuation">,</span>
  publicKey_Alice<span class="token punctuation">,</span>
  publicKey_Bob<span class="token punctuation">,</span>
  timelock
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Derive P2SH address from the script</span>
<span class="token keyword">const</span> BTC_AddrFromScript <span class="token operator">=</span> BTC_Swap<span class="token punctuation">.</span><span class="token function">getAddressFromRedeemScript</span><span class="token punctuation">(</span>BTC_RedeemScript<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> BTC_P2SH_Address <span class="token operator">=</span> BTC_AddrFromScript<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'testnet'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create a watch-only wallet to catch Alice's BTC sweep and get its details</span>
BTC_WalletInfo <span class="token operator">=</span> <span class="token keyword">await</span> BTC_WalletClient<span class="token punctuation">.</span><span class="token function">createWallet</span><span class="token punctuation">(</span><span class="token string">'SwapWithAlice'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>watchOnly<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Get the wallet we just created</span>
<span class="token keyword">const</span> BTC_Wallet <span class="token operator">=</span> BTC_WalletClient<span class="token punctuation">.</span><span class="token function">wallet</span><span class="token punctuation">(</span><span class="token string">'SwapWithAlice'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Import the watch-only address into the wallet's default account</span>
<span class="token keyword">await</span> BTC_Wallet<span class="token punctuation">.</span><span class="token function">importAddress</span><span class="token punctuation">(</span><span class="token string">'default'</span><span class="token punctuation">,</span> BTC_P2SH_Address<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Listen for events by "joining" the wallet with it's API token</span>
<span class="token keyword">await</span> BTC_WalletClient<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'SwapWithAlice'</span><span class="token punctuation">,</span> BTC_WalletInfo<span class="token punctuation">.</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Establish the entire swap-seep procedure and bind it to the watch-only wallet</span>
BTC_Wallet<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">'confirmed'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>wallet<span class="token punctuation">,</span> txDetails<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>

    <span class="token comment">// Get details from Alice's TX, emitted by the event</span>
    <span class="token keyword">const</span> fundingTX <span class="token operator">=</span> BTC_Swap<span class="token punctuation">.</span>TX<span class="token punctuation">.</span><span class="token function">fromRaw</span><span class="token punctuation">(</span>txDetails<span class="token punctuation">.</span>tx<span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Extract the HTLC secret value</span>
    <span class="token keyword">const</span> revealedSecret <span class="token operator">=</span> BTC_Swap<span class="token punctuation">.</span><span class="token function">extractSecret</span><span class="token punctuation">(</span>
      fundingTX<span class="token punctuation">,</span>
      BTC_P2SH_Address
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/*  Create a TX on the BITCOIN CASH chain to sweep Alice's BCH output.
     *  We assume `BCH_RedeemScript` has already been derived and we have verified
     *  that Alice has sent the right amount of BCH to that P2SH address.
     *  Alice's BCH funding TX is stored as `Alices_BCH_FundingTX`, and
     *  the output that concerns Bob is `Alices_BCH_FundingTX_OutputIndex`.
     */</span>

    <span class="token comment">// Derive the input script to redeem the BCH transaction</span>
    <span class="token keyword">const</span> BCH_SwapScript <span class="token operator">=</span> BCH_Swap<span class="token punctuation">.</span><span class="token function">getSwapInputScript</span><span class="token punctuation">(</span>
      BCH_RedeemScript<span class="token punctuation">,</span>
      revealedSecret
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Build a BCH transaction to spend Alice's output</span>
    <span class="token keyword">const</span> swapTX <span class="token operator">=</span> BCH_Swap<span class="token punctuation">.</span><span class="token function">getRedeemTX</span><span class="token punctuation">(</span>
      Bobs_BCH_WalletAddress<span class="token punctuation">,</span>
      feeRate<span class="token punctuation">,</span>
      Alices_BCH_FundingTX<span class="token punctuation">,</span>
      Alices_BCH_FundingTX_OutputIndex<span class="token punctuation">,</span>
      BCH_RedeemScript<span class="token punctuation">,</span>
      BCH_SwapScript<span class="token punctuation">,</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span>
      Bobs_PrivateKey
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Finalize and serialize the TX for broadcast</span>
    <span class="token keyword">const</span> finalTX <span class="token operator">=</span> swapTX<span class="token punctuation">.</span><span class="token function">toTX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> stringTX <span class="token operator">=</span> finalTX<span class="token punctuation">.</span><span class="token function">toRaw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Broadcast BCH swap-sweep TX, and we're done!</span>
    <span class="token keyword">const</span> broadcastResult <span class="token operator">=</span> <span class="token keyword">await</span> BCH_NodeClient<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span>stringTX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><button class="copy-button"><img src="../assets/images/clippy.svg" alt="Copy to clipboard"></button></pre><p>Alice will have similar code running on her end. When she broadcasts her BTC sweep
transaction, Bob&#39;s code will automatically catch it, derive the HTLC secret, and
sweep the BCH transaction.</p>
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/utOAL2Uw_Mk?rel=1" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<p><a name="next-steps"></a></p>
<h2 id="next-steps">Next steps</h2><p>We&#39;ve built a very simple atomic swaps application! But what have we sacrificed for convenience?</p>
<ul>
<li><p>To improve privacy, we might want to use separate public keys for each blockchain, instead of using
the same key on both networks (although it is very cool and convenient that public keys can be re-used
on these two networks).</p>
</li>
<li><p>We have been using raw public keys, but most of the time in Bitcoin we exchange hashed (RIPE-160)
public keys. In our case, this hash would require a few extra OP codes in the redeem script.</p>
</li>
<li><p>We should also check all the amounts being transacted and return an error if the counterparty didn&#39;t
send the right amount.</p>
</li>
<li><p>The watch-only wallets work great, but what if Bob creates his watch-only wallet AFTER Alice sends
her first transaction? How will Bob ever know? The app should be able to rescan recent blockchain
history to make sure it hasn&#39;t missed anything on launch.</p>
</li>
<li><p>CSV encoding. We built our app using timelocks based in seconds, not blocks.
BIP 68 describes a specific bit-by-bit encoding scheme that must be used to create a valid timelock value.
Look for the function <code>CSVencode()</code> in <code>lib/swap.js</code></p>
</li>
<li><p>User interface: all this command line copying/pasting is not a great user experience. A better
UI or <a href="https://bpanel.org/docs/plugin-started.html">bpanel plugin</a> would make the application much easier to use.</p>
</li>
</ul>
<p>If you have any ideas or suggestions please feel free to post an issue or pull request
in the proof-of-concept repo! <a href="https://github.com/pinheadmz/swap-test">https://github.com/pinheadmz/swap-test</a></p>
<p><strong>HAPPY SWAPPING!</strong></p>
<h2 id="references">References</h2><p><a href="https://github.com/decred/atomicswap">On-chain atomic swaps for Decred and other cryptocurrencies.</a></p>
<p><a href="https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch12.asciidoc#hash-time-lock-contracts-htlc">Mastering Bitcoin: Hash Time Lock Contracts (HTLC)</a></p>
<p><a href="https://www.youtube.com/watch?v=i7wnagAyqvc">SF Cryptocurrency Dev: James Prestwich&#39;s Summa: Atomic, Cross-chain Contracts</a></p>
<p><a href="https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki">BIP 68: Relative lock-time using consensus-enforced sequence numbers</a></p>
<p><a href="https://github.com/bitcoin/bips/blob/master/bip-0016.mediawiki">BIP 16: Pay to Script Hash</a></p>
<h2 id="related-reading">Related reading</h2><p><a href="scripting.html">Intro to Scripting</a></p>
<p><a href="cltv.html">Time Locked Bitcoin Transactions w/ CLTV</a></p>
<p><a href="working-with-txs.html">Working with transactions</a></p>
<p><a href="events.html">Events and Sockets</a></p>


					<!-- END OF GUIDE -->
									</div>
								</div>
							</div>
						</div>
					</article>
					<!-- END OF ARTICLE CONTAINER -->

					</div>
					<!-- END BLOG CONTENT -->

					<!-- START SIDEBAR -->
<div class="col-sm-3 sidebar">
  <!-- TEXT WIDGET -->
  <div class="widget">
    <h6 class="montserrat text-uppercase bottom-line">Installation</h6>
      <p>
        <a href="https://github.com/bcoin-org/bcoin/blob/master/docs/getting-started.md">
          See the "Getting Started" guide in the repository documents directory.
        </a>
      </p>
  </div>
  <!-- END TEXT WIDGET -->

  <!-- CATEGORIES WIDGET -->
<div class="widget guide-list">
<h6 class="montserrat text-uppercase bottom-line">Guides</h6>
<ul class="icons-list">
<!-- GUIDES-LIST -->
<li><a href="working-with-txs.html">Working with transactions</a></li>
<li><a href="webapp.html">Building web applications with the bcoin library</a></li>
<li><a href="wallets.html">Wallets and Accounts and Keys, Oh My!</a></li>
<li><a href="swaps.html">Cross-Chain Atomic Swaps</a></li>
<li><a href="segwit.html">Segwit and Bcoin</a></li>
<li><a href="scripting.html">Intro to Scripting</a></li>
<li><a href="op_return.html">Store Data on the Blockchain</a></li>
<li><a href="multisig-tx.html">Creating Multisignature Transactions</a></li>
<li><a href="multisig-cli.html">Multisig on the command line</a></li>
<li><a href="generate-address.html">Generate an Address</a></li>
<li><a href="events.html">Events and Sockets</a></li>
<li><a href="crowdfund-tx.html">Create a Crowdfunding Transaction</a></li>
<li><a href="connect-local-nodes.html">Connect two local nodes</a></li>
<li><a href="cltv.html">Time Locked Bitcoin Transactions w/ CLTV</a></li>
<li><a href="building-plugins.html">Building Awesome bcoin Plugins</a></li>
<li><a href="browser.html">Run a bcoin full node in a web browser</a></li>
<li><a href="bcoin-clock.html">Make your own Bcoin Block Clock!</a></li>
<!-- /GUIDES-LIST -->
</ul>
</div>
  <!-- END CATEGORIES WIDGET -->

  <!-- TEXT WIDGET -->
  <div class="widget">
    <h6 class="montserrat text-uppercase bottom-line">Looking for Docs?</h6>
    <p>Checkout our <a href="../api-docs/index.html">API Docs</a> or the <a href="https://bcoin.io/docs/index.html">Full Documentation</a></p>
  </div>
  <!-- END TEXT WIDGET -->

  <!-- TEXT WIDGET -->
  <div class="widget">
    <h6 class="montserrat text-uppercase bottom-line">Get Involved</h6>
    <p>If you think you've got what it takes to make your own bcoin guides and tutorials, head on over to our <a href="https://github.com/bcoin-org/bcoin-org.github.io">GitHub repo</a> to see how you can make a request or contribute your own and earn bounties! You can also reach out to us on <a href="https://t.me/bcoinorg"> Telegram.</a></p>
  </div>
  <!-- END TEXT WIDGET -->
</div>

					<!-- END SIDEBAR -->

				</div><!-- .row -->

			</div>
		</section>
		<!-- END NEW BLOGS -->

				</div><!-- .row -->

			</div>
		</section>
		<!-- END BLOGS -->


		<!-- PARALLAX DOCS CTA -->
		<section class="module bg-white-alfa-30 parallax color-white" data-background="../assets/images/bg-header.jpg">
			<div class="container">

				<div class="row">
					<div class="col-sm-12">
						<div class="text-center">
							<h2 class="montserrat text-uppercase m-b-30">Ready to start building? Read the docs!</h2>
							<a href="https://bcoin.io/docs/index.html" target="_blank" class="btn btn-lg btn-purple">Documentation</a>
						</div>
					</div>
				</div><!-- .row -->

			</div>
		</section>
		<!-- END PARALLAX DOCS CTA -->

		<!-- FOOTER -->
		<footer id="footer" class="footer-minimal">
			<div class="container">

				<div class="row">
					<div class="col-sm-12">
						<ul class="social-icons social-icons-circle text-center m-b-35">
							<li><a href="https://twitter.com/bcoin"><i class="fa fa-twitter"></i></a></li>
							<li><a href="https://github.com/bcoin-org/bcoin"><i class="fa fa-github"></i></a></li>


							<li><a href="https://t.me/bcoinorg" target="_blank"><img src="assets/images/telegram-app.svg"></a></li>
						</ul>
					</div>
				</div>
				<div class="row">
					<div class="col-sm-12 text-center m-b-35">
						<img class="m-b-35 QR-code" src="../assets/images/donation_QR.png"/>
						<p class="m-0"><strong>Bcoin Development Donation Address:</strong><br />3Bi9H1hzCHWJoFEjc4xzVzEMywi35dyvsV</p>

					</div>
				</div>
				<div class="row">
					<div class="col-sm-12 text-center">
						<p class="m-0">Copyright <a href="#">bcoin.io, Purse</a>, 2018, All Rights Reserved.</p>

					</div>
				</div>

			</div>
		</footer>
		<!-- END FOOTER -->

	</div>
	<!-- /WRAPPER -->

	<!-- JAVASCRIPT FILES -->

	<script src="../assets/js/jquery-2.2.3.min.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?v=3"></script>
	<script src="../assets/bootstrap/js/bootstrap.min.js"></script>
	<script src="../assets/js/plugins.min.js"></script>
	<script src="../assets/js/stickyfill.min.js"></script>
	<script src="../assets/js/custom.min.js"></script>
	<script src="../assets/js/clipboard.min.js"></script>
	<script async defer src="../assets/js/prism.js"></script>
	<script>
		var copyCode = new Clipboard('.copy-button', {
		    target: function(trigger) {
		        return trigger.previousElementSibling;
		    }
		});

		copyCode.on('success', function(event) {
		    event.trigger.classList.add('success');
		    event.clearSelection();
		    // event.trigger.textContent = 'Copied!';
		    window.setTimeout(function() {
		        event.trigger.classList.remove('success');
		    }, 2000);
		});
	</script>

  <!-- github button js -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>

</body>
</html>
